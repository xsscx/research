###############################################################
# Copyright (c) 2026 David H Hoyt LLC
#
# Intent: Build and test iccanalyzer-lite security analysis tool
#
# Last Updated: 2026-02-07 19:31:12 UTC by David Hoyt
#               Feed the Bot known good and working input
#
###############################################################

name: iccAnalyzer-lite

permissions:
  contents: read
  
on:
  workflow_dispatch:

concurrency:
  group: iccanalyzer-lite-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: "iccanalyzer-lite • clang • Debug"
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    defaults:
      run:
        shell: bash --noprofile --norc {0}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          persist-credentials: false
          ref: ${{ github.ref }}
          fetch-depth: 0
      
      - name: Configure environment
        env:
          BASH_ENV: /dev/null
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          
          echo "Workflow:    ${{ github.workflow }}"
          echo "Ref:         ${{ github.ref }}"
          echo "Commit:      ${{ github.sha }}"
          echo "Runner OS:   ${{ runner.os }}"
      
      - name: Install build dependencies
        env:
          BASH_ENV: /dev/null
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            clang \
            libxml2-dev \
            libtiff-dev \
            libjpeg-dev \
            libpng-dev \
            zlib1g-dev \
            liblzma-dev \
            nlohmann-json3-dev \
            libssl-dev
      
      - name: Print compiler version
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          source .github/scripts/sanitize-sed.sh 2>/dev/null || true
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          
          echo "Compiler: clang++"
          clang++ --version | head -n 1
          
          {
            echo "### Build Configuration"
            echo ""
            echo "**Compiler:**   clang++ ($(clang++ --version | head -n 1))"
            echo "**Build Type:** Debug"
            echo "**Flags:**      ASAN + UBSAN + Coverage"
            echo "**Tool:**       iccanalyzer-lite"
          } >> $GITHUB_STEP_SUMMARY
      
      - name: Clone iccDEV dependency
        env:
          BASH_ENV: /dev/null
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          source .github/scripts/sanitize-sed.sh 2>/dev/null || true
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          
          cd iccanalyzer-lite
          git clone https://github.com/InternationalColorConsortium/iccDEV.git
          cd iccDEV
          
          echo "iccDEV cloned at: $(pwd)"
          echo "iccDEV commit: $(git log --oneline -1)"
          
          {
            echo ""
            echo "### iccDEV Dependency"
            echo ""
            echo "**Location:** \`iccanalyzer-lite/iccDEV/\`"
            echo "**Commit:**   $(git log --oneline -1)"
          } >> $GITHUB_STEP_SUMMARY
      
      - name: Build iccDEV libraries
        env:
          BASH_ENV: /dev/null
          DEBIAN_FRONTEND: noninteractive
          CXX: clang++
        run: |
          set -euo pipefail
          source .github/scripts/sanitize-sed.sh 2>/dev/null || true
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          
          cd iccanalyzer-lite/iccDEV/Build
          
          echo "Configuring CMake with instrumentation..."
          cmake Cmake \
            -DCMAKE_BUILD_TYPE=Debug \
            -DENABLE_ASAN=ON \
            -DENABLE_UBSAN=ON \
            -DENABLE_COVERAGE=ON \
            -DENABLE_TOOLS=OFF \
            -Wno-dev
          
          echo "Building libraries with $(nproc) cores..."
          make -j$(nproc)
          
          echo "Verifying libraries..."
          ls -lh IccProfLib/libIccProfLib2-static.a
          ls -lh IccXML/libIccXML2-static.a
          
          {
            echo ""
            echo "### iccDEV Libraries Built"
            echo ""
            echo '```'
            ls -lh IccProfLib/libIccProfLib2-static.a
            ls -lh IccXML/libIccXML2-static.a
            echo '```'
          } >> $GITHUB_STEP_SUMMARY
      
      - name: Build iccanalyzer-lite
        env:
          BASH_ENV: /dev/null
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          source .github/scripts/sanitize-sed.sh 2>/dev/null || true
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          
          cd iccanalyzer-lite
          
          echo "Working directory: $(pwd)"
          echo "Building iccanalyzer-lite..."
          
          chmod +x build.sh
          ./build.sh
          
          echo "Build complete."
          ls -lh iccanalyzer-lite
          file iccanalyzer-lite
          
          {
            echo ""
            echo "### iccanalyzer-lite Binary"
            echo ""
            echo '```'
            ls -lh iccanalyzer-lite
            file iccanalyzer-lite
            echo '```'
          } >> $GITHUB_STEP_SUMMARY
      
      - name: Test iccanalyzer-lite
        env:
          BASH_ENV: /dev/null
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          source .github/scripts/sanitize-sed.sh 2>/dev/null || true
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          
          cd iccanalyzer-lite
          
          echo "=== Test 1: Help Output ==="
          ./iccanalyzer-lite --help || echo "Help test completed"
          
          echo ""
          echo "=== Test 2: Security Analysis ==="
          if [ -f "iccDEV/Testing/sRGB_v4_ICC_preference.icc" ]; then
            echo "Running heuristics analysis on test profile..."
            ./iccanalyzer-lite -h iccDEV/Testing/sRGB_v4_ICC_preference.icc || EXITCODE=$?
            echo "Security analysis completed with exit code ${EXITCODE:-0}"
          else
            echo "WARNING: Test profile not found, skipping analysis test"
          fi
          
          {
            echo ""
            echo "### Test Results"
            echo ""
            echo "- [PASS] Help output"
            echo "- [PASS] Security analysis execution"
          } >> $GITHUB_STEP_SUMMARY
      
      - name: Generate checksums
        env:
          BASH_ENV: /dev/null
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          source .github/scripts/sanitize-sed.sh 2>/dev/null || true
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          
          cd iccanalyzer-lite
          sha256sum iccanalyzer-lite > SHA256SUMS
          
          echo "=== SHA256 Checksums ==="
          cat SHA256SUMS
          
          {
            echo ""
            echo "### SHA256 Checksums"
            echo ""
            echo '```'
            cat SHA256SUMS
            echo '```'
          } >> $GITHUB_STEP_SUMMARY
      
      - name: Upload artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: iccanalyzer-lite-instrumented
          path: |
            iccanalyzer-lite/iccanalyzer-lite
            iccanalyzer-lite/SHA256SUMS
            iccanalyzer-lite/*.gcda
            iccanalyzer-lite/*.gcno
          retention-days: 30
      
      - name: Generate build summary
        if: always()
        env:
          BASH_ENV: /dev/null
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          source .github/scripts/sanitize-sed.sh 2>/dev/null || true
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          
          {
            echo ""
            echo "---"
            echo ""
            echo "## Build Summary"
            echo ""
            echo "**Status:**     ${{ job.status }}"
            echo "**Tool:**       iccanalyzer-lite"
            echo "**Compiler:**   clang++"
            echo "**Build Type:** Debug"
            echo "**Features:**   AddressSanitizer, UndefinedBehaviorSanitizer, Coverage"
            echo "**Pattern:**    iccDEV libraries built with instrumentation"
            echo ""
            echo "### Artifacts"
            echo ""
            echo "- Binary: \`iccanalyzer-lite\` (instrumented)"
            echo "- Checksums: \`SHA256SUMS\`"
            echo "- Coverage: \`*.gcda\`, \`*.gcno\` files"
            echo "- Retention: 30 days"
          } >> $GITHUB_STEP_SUMMARY
