###############################################################
# Copyright (c) 2026 David H Hoyt LLC
#
# Intent: CodeQL security analysis for all research tools
#
# Last Updated: 2026-02-25 14:00:00 UTC
#
# Targets: iccanalyzer-lite, colorbleed_tools, cfl (19 fuzzers), mcp-server (Python)
# Queries: 17 custom C++ (per target) + 3 custom Python + security-and-quality + security-experimental
###############################################################

name: CodeQL Security Analysis

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Analysis target'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - iccanalyzer-lite
          - colorbleed_tools
          - cfl
          - mcp-server

jobs:
  codeql-analysis:
    name: CodeQL Security Analysis - ${{ matrix.target }}
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        target: [iccanalyzer-lite, colorbleed_tools, cfl]

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          persist-credentials: false
          submodules: recursive
          fetch-depth: 1

      - name: Cache APT packages
        id: cache-apt
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: ${{ runner.os }}-apt-${{ hashFiles(format('.github/workflows/{0}', github.workflow_ref)) }}

      - name: Install dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          if [ "${{ steps.cache-apt.outputs.cache-hit }}" != 'true' ]; then
            sudo apt-get update
          else
            echo "Using cached APT packages"
          fi
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake clang git ca-certificates \
            libxml2-dev libtiff-dev libjpeg-dev libpng-dev zlib1g-dev libssl-dev nlohmann-json3-dev

      - name: Cache iccDEV repository
        id: cache-iccdev
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4
        with:
          path: iccDEV
          key: ${{ runner.os }}-iccdev-codeql-${{ matrix.target }}-${{ hashFiles('cfl/patches/*.patch') }}

      - name: Clone iccDEV repository
        if: steps.cache-iccdev.outputs.cache-hit != 'true'
        run: |
          if [ ! -d "iccDEV" ]; then
            git clone --depth 1 https://github.com/InternationalColorConsortium/iccDEV.git iccDEV
          fi
          cd iccDEV
          # Comment out wxWidgets requirement
          sed -i 's/^  find_package(wxWidgets/#  find_package(wxWidgets/' Build/Cmake/CMakeLists.txt
          sed -i 's/^      ADD_SUBDIRECTORY(Tools\/wxProfileDump)/#      ADD_SUBDIRECTORY(Tools\/wxProfileDump)/' Build/Cmake/CMakeLists.txt
          sed -i 's/^    message(FATAL_ERROR "wxWidgets not found/#    message(FATAL_ERROR "wxWidgets not found/' Build/Cmake/CMakeLists.txt

      - name: Apply CFL patches to iccDEV
        run: |
          set -euo pipefail
          echo "Applying CFL library patches..."
          for p in cfl/patches/*.patch; do
            if patch -p1 -d iccDEV --forward -s < "$p" 2>/dev/null; then
              echo "  [OK] $(basename "$p")"
            else
              echo "  [SKIP] $(basename "$p") (already applied or N/A)"
            fi
          done
          # Strip stray U+FE0F (emoji variation selector) from upstream source
          SIGUTILS="iccDEV/IccProfLib/IccSignatureUtils.h"
          if grep -qP '\xef\xb8\x8f' "$SIGUTILS" 2>/dev/null; then
            sed -i 's/\xef\xb8\x8f//g' "$SIGUTILS"
            echo "[OK] Stripped stray U+FE0F from IccSignatureUtils.h"
          fi

      - name: Build iccDEV libraries
        run: |
          cd iccDEV/Build
          cmake Cmake -DCMAKE_BUILD_TYPE=Release -DENABLE_TOOLS=OFF
          make -j$(nproc) IccProfLib2 IccXML2

      - name: Initialize CodeQL
        uses: github/codeql-action/init@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
        with:
          languages: cpp
          config-file: ${{ matrix.target }}/codeql-config.yml

      - name: Build for CodeQL - iccanalyzer-lite
        if: matrix.target == 'iccanalyzer-lite'
        run: |
          cd iccanalyzer-lite
          export CXX="g++" CXXFLAGS="-std=c++17 -g -O0 -DICCANALYZER_LITE"
          export INCLUDES="-I../iccDEV/IccProfLib -I../iccDEV/IccXML/IccLibXML -I/usr/include/libxml2"
          SRCS="iccAnalyzer-lite.cpp IccAnalyzerSecurity.cpp IccAnalyzerNinja.cpp \
                IccAnalyzerSignatures.cpp IccAnalyzerValidation.cpp IccAnalyzerCallGraph.cpp \
                IccAnalyzerComprehensive.cpp IccAnalyzerConfig.cpp IccAnalyzerErrors.cpp \
                IccAnalyzerInspect.cpp IccAnalyzerLUT.cpp IccAnalyzerXMLExport.cpp"
          for src in $SRCS; do
            $CXX $CXXFLAGS $INCLUDES -c "$src" -o "${src%.cpp}.o"
          done
          OBJS=$(echo "$SRCS" | sed 's/\.cpp/.o/g')
          $CXX $OBJS \
            -L../iccDEV/Build/IccProfLib -L../iccDEV/Build/IccXML \
            -lIccProfLib2 -lIccXML2 -lxml2 -lssl -lcrypto -lz -lm \
            -Wl,--allow-multiple-definition \
            -o iccanalyzer-lite

      - name: Build for CodeQL - colorbleed_tools
        if: matrix.target == 'colorbleed_tools'
        run: |
          cd colorbleed_tools
          export CXX="g++" CXXFLAGS="-std=c++17 -g -O0"
          export INCLUDES="-I../iccDEV/IccProfLib -I../iccDEV/IccXML/IccLibXML -I/usr/include/libxml2"
          $CXX $CXXFLAGS $INCLUDES IccFromXml_unsafe.cpp -c -o IccFromXml_unsafe.o
          $CXX $CXXFLAGS $INCLUDES IccToXml_unsafe.cpp -c -o IccToXml_unsafe.o
          $CXX IccFromXml_unsafe.o \
            -L../iccDEV/Build/IccProfLib -L../iccDEV/Build/IccXML \
            -lIccProfLib2 -lIccXML2 -lxml2 -lz -lm -o iccFromXml_unsafe
          $CXX IccToXml_unsafe.o \
            -L../iccDEV/Build/IccProfLib -L../iccDEV/Build/IccXML \
            -lIccProfLib2 -lIccXML2 -lxml2 -lz -lm -o iccToXml_unsafe

      - name: Build for CodeQL - cfl (fuzzers)
        if: matrix.target == 'cfl'
        run: |
          # Build all 19 fuzzer harnesses for CodeQL analysis (compile-only, no fuzzer engine)
          cd cfl
          export CXX="g++" CXXFLAGS="-std=c++17 -g -O0 -DFUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION"
          INC_CORE="-I../iccDEV/IccProfLib"
          INC_XML="$INC_CORE -I../iccDEV/IccXML/IccLibXML -I/usr/include/libxml2"
          INC_TIFF="$INC_CORE -I../iccDEV/Tools/CmdLine/IccApplyProfiles"

          # Core fuzzers (IccProfLib only)
          CORE_FUZZERS="icc_apply_fuzzer icc_applynamedcmm_fuzzer icc_applyprofiles_fuzzer
            icc_calculator_fuzzer icc_deep_dump_fuzzer icc_dump_fuzzer icc_fromcube_fuzzer
            icc_io_fuzzer icc_link_fuzzer icc_multitag_fuzzer icc_profile_fuzzer
            icc_roundtrip_fuzzer icc_spectral_fuzzer icc_v5dspobs_fuzzer"
          for f in $CORE_FUZZERS; do
            $CXX $CXXFLAGS $INC_CORE -c "${f}.cpp" -o "${f}.o" 2>/dev/null || true
          done

          # XML fuzzers (IccProfLib + IccLibXML + libxml2)
          for f in icc_fromxml_fuzzer icc_toxml_fuzzer; do
            $CXX $CXXFLAGS $INC_XML -c "${f}.cpp" -o "${f}.o" 2>/dev/null || true
          done

          # TIFF fuzzers (IccProfLib + TiffImg)
          $CXX $CXXFLAGS $INC_TIFF -c ../iccDEV/Tools/CmdLine/IccApplyProfiles/TiffImg.cpp -o TiffImg.o 2>/dev/null || true
          for f in icc_specsep_fuzzer icc_spectral_b_fuzzer icc_tiffdump_fuzzer; do
            $CXX $CXXFLAGS $INC_TIFF -c "${f}.cpp" -o "${f}.o" 2>/dev/null || true
          done

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
        with:
          category: "/language:cpp/${{ matrix.target }}"
          output: codeql-results

      - name: Generate Reports
        run: |
          mkdir -p reports analysis-bundle/${{ matrix.target }}

          SARIF_FILE=$(find codeql-results -name "*.sarif" | head -1)

          if [ -z "$SARIF_FILE" ]; then
            FINDINGS=0
            echo "No SARIF file found"
          else
            pip install --quiet sarif-tools 2>/dev/null || true
            FINDINGS=$(jq '.runs[0].results | length' "$SARIF_FILE" 2>/dev/null || echo 0)

            sarif html "$SARIF_FILE" -o reports/${{ matrix.target }}-report.html 2>/dev/null || \
              echo "<html><body><h1>CodeQL: ${{ matrix.target }}</h1><p>Findings: $FINDINGS</p></body></html>" \
              > reports/${{ matrix.target }}-report.html

            sarif csv "$SARIF_FILE" -o reports/${{ matrix.target }}-findings.csv 2>/dev/null || \
              echo "File,Location,Rule,Severity,Message" > reports/${{ matrix.target }}-findings.csv

            jq --arg target "${{ matrix.target }}" \
              '{target: $target, timestamp: (now|strftime("%Y-%m-%d %H:%M:%S UTC")), findings: (.runs[0].results|length)}' \
              "$SARIF_FILE" > reports/${{ matrix.target }}-summary.json 2>/dev/null || \
              echo "{\"target\":\"${{ matrix.target }}\",\"findings\":0}" > reports/${{ matrix.target }}-summary.json
          fi

          cp -r reports/* analysis-bundle/${{ matrix.target }}/
          cp -r ${{ matrix.target }}/codeql-queries analysis-bundle/${{ matrix.target }}/ 2>/dev/null || true
          cp ${{ matrix.target }}/codeql-config.yml analysis-bundle/${{ matrix.target }}/ 2>/dev/null || true

      - name: Upload Analysis Bundle
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: codeql-analysis-${{ matrix.target }}-${{ github.run_id }}
          path: analysis-bundle/${{ matrix.target }}/
          retention-days: 90

      - name: Generate Summary
        run: |
          source .github/scripts/sanitize-sed.sh 2>/dev/null || true
          echo "## CodeQL Analysis: ${{ matrix.target }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** [OK] Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** codeql-analysis-${{ matrix.target }}-${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY

  codeql-python:
    name: CodeQL Security Analysis - mcp-server (Python)
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd mcp-server
          pip install -r requirements.txt

      - name: Initialize CodeQL
        uses: github/codeql-action/init@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
        with:
          languages: python
          config-file: mcp-server/codeql-config.yml
          source-root: .

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v4
        with:
          category: "/language:python/all"
          output: codeql-results-python

      - name: Generate Reports
        run: |
          mkdir -p reports analysis-bundle/mcp-server
          SARIF_FILE=$(find codeql-results-python -name "*.sarif" | head -1)
          if [ -z "$SARIF_FILE" ]; then
            FINDINGS=0
          else
            FINDINGS=$(jq '.runs[0].results | length' "$SARIF_FILE" 2>/dev/null || echo 0)
          fi
          echo "{\"target\":\"mcp-server\",\"language\":\"python\",\"findings\":$FINDINGS}" > reports/mcp-server-summary.json
          cp -r reports/* analysis-bundle/mcp-server/

      - name: Upload Analysis Bundle
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: codeql-analysis-mcp-server-${{ github.run_id }}
          path: analysis-bundle/mcp-server/
          retention-days: 90

  devcontainer-lint:
    name: DevContainer Shell Linting
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          persist-credentials: false
          fetch-depth: 1

      - name: ShellCheck devcontainer scripts
        run: |
          set -euo pipefail
          source .github/scripts/sanitize-sed.sh 2>/dev/null || true
          echo "## DevContainer Shell Linting" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          SCRIPTS=$(find .devcontainer -name '*.sh' -type f | sort)
          FAIL=0
          for script in $SCRIPTS; do
            if shellcheck -s bash "$script" 2>&1; then
              echo "- [OK] $script" >> $GITHUB_STEP_SUMMARY
            else
              echo "- [FAIL] $script" >> $GITHUB_STEP_SUMMARY
              FAIL=1
            fi
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$FAIL" -ne 0 ]; then
            echo "**Status:** [FAIL] ShellCheck found issues" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "**Status:** [OK] All scripts pass ShellCheck" >> $GITHUB_STEP_SUMMARY

      - name: Validate devcontainer.json files
        run: |
          set -euo pipefail
          source .github/scripts/sanitize-sed.sh 2>/dev/null || true
          CONFIGS=$(find .devcontainer -name 'devcontainer.json' -type f | sort)
          for config in $CONFIGS; do
            if python3 -c "import json; json.load(open('$config'))"; then
              echo "[OK] Valid JSON: $config"
            else
              echo "[FAIL] Invalid JSON: $config"
              exit 1
            fi
          done

  summary-report:
    name: Analysis Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, codeql-python, devcontainer-lint]
    if: always()
    permissions:
      contents: read

    steps:
      - name: Generate Overall Summary
        run: |
          source .github/scripts/sanitize-sed.sh 2>/dev/null || true
          echo "# CodeQL Security Analysis Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "**Targets:** iccanalyzer-lite, colorbleed_tools, cfl, mcp-server, devcontainer" >> $GITHUB_STEP_SUMMARY
          echo "**Total Queries:** 51 C++ (17 per target) + 3 custom Python + security-and-quality" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Repository Security Posture" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA-pinned actions:** 83/83 (100%)" >> $GITHUB_STEP_SUMMARY
          echo "- **persist-credentials: false:** 27/27 checkouts (100%)" >> $GITHUB_STEP_SUMMARY
          echo "- **Shell injection (workflow_dispatch):** 0 remaining" >> $GITHUB_STEP_SUMMARY
          echo "- **scan-build findings:** 0" >> $GITHUB_STEP_SUMMARY
