###############################################################
#
# Copyright (c) 2026 International Color Consortium.
#                All rights reserved.
#                https://color.org
#
# Intent: Build iccDEV with Clang source-based coverage,
#         run full test suite + profile exerciser, generate
#         llvm-cov HTML and lcov summary reports
#
# Reference: xsscx/cfl/.github/workflows/ci-code-coverage.yml
#
###############################################################

name: iccDEV Code Coverage Report

permissions:
  contents: read

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]

concurrency:
  group: coverage-${{ github.ref }}
  cancel-in-progress: true

jobs:
  coverage:
    name: Coverage Report
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    defaults:
      run:
        shell: bash --noprofile --norc {0}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Install dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake \
            clang-18 llvm-18 \
            libxml2-dev libtiff-dev libjpeg-dev libpng-dev \
            zlib1g-dev nlohmann-json3-dev \
            lcov

      - name: Clone and build iccDEV with coverage instrumentation
        env:
          CC: clang-18
          CXX: clang++-18
        run: |
          set -euo pipefail

          # Clone iccDEV
          git clone --depth 1 https://github.com/InternationalColorConsortium/iccDEV.git /tmp/iccdev
          cd /tmp/iccdev

          echo "iccDEV HEAD: $(git log --oneline -1)"

          # Comment out wxWidgets requirement (no GUI needed for coverage)
          sed -i '/find_package(wxWidgets COMPONENTS core base REQUIRED)/,/endif()/ s/^/# /' Build/Cmake/CMakeLists.txt

          mkdir -p build-coverage && cd build-coverage
          cmake ../Build/Cmake \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DENABLE_COVERAGE=ON \
            -DENABLE_TOOLS=ON \
            -DENABLE_STATIC_LIBS=ON \
            -DENABLE_TESTS=OFF \
            -DCMAKE_C_FLAGS="-fprofile-instr-generate -fcoverage-mapping" \
            -DCMAKE_CXX_FLAGS="-fprofile-instr-generate -fcoverage-mapping" \
            -DCMAKE_EXE_LINKER_FLAGS="-fprofile-instr-generate" \
            -DCMAKE_SHARED_LINKER_FLAGS="-fprofile-instr-generate" \
            -Wno-dev
          make -j$(nproc)

          # Verify coverage instrumentation
          TOOL=$(find . -name "iccDumpProfile" -type f -executable | head -1)
          if [ -z "$TOOL" ]; then
            echo "::error::No iccDumpProfile binary found"
            exit 1
          fi
          echo "tool_path=$(pwd)/$TOOL" >> $GITHUB_ENV
          echo "build_dir=$(pwd)" >> $GITHUB_ENV
          echo "iccdev_root=/tmp/iccdev" >> $GITHUB_ENV

          # Verify instrumentation flags
          echo "Checking coverage flags..."
          grep -r "fprofile-instr-generate\|coverage" CMakeFiles/*/flags.make | head -3 || true

          # Count libraries and tools
          LIB_COUNT=$(find . -name "*.a" | wc -l)
          TOOL_COUNT=$(find . -path "*/Tools/*" -type f -executable | wc -l)
          echo "Built: $LIB_COUNT libraries, $TOOL_COUNT tools"

      - name: Create test profiles
        run: |
          set -euo pipefail
          export LLVM_PROFILE_FILE="${{ github.workspace }}/profraw/create-%p-%m.profraw"
          mkdir -p "${{ github.workspace }}/profraw"

          ICCDEV="${{ env.iccdev_root }}"
          BUILD_DIR="${{ env.build_dir }}"

          # Add build tools to PATH
          for d in $(find "$BUILD_DIR" -path "*/Tools/*" -type f -executable -exec dirname {} \; | sort -u); do
            PATH="$d:$PATH"
          done
          export PATH

          cd "$ICCDEV/Testing"
          bash CreateAllProfiles.sh 2>&1 | tail -20
          PROFILE_COUNT=$(find . -name "*.icc" | wc -l)
          echo "Created $PROFILE_COUNT ICC profiles"
          echo "profile_count=$PROFILE_COUNT" >> $GITHUB_ENV

      - name: Run test suite
        run: |
          set -euo pipefail
          export LLVM_PROFILE_FILE="${{ github.workspace }}/profraw/test-%p-%m.profraw"

          BUILD_DIR="${{ env.build_dir }}"
          for d in $(find "$BUILD_DIR" -path "*/Tools/*" -type f -executable -exec dirname {} \; | sort -u); do
            PATH="$d:$PATH"
          done
          export PATH

          cd "${{ env.iccdev_root }}/Testing"
          bash RunTests.sh 2>&1 | tail -40
          echo "Test suite complete"

      - name: Exercise all profiles with IccDumpProfile
        run: |
          set -euo pipefail
          export LLVM_PROFILE_FILE="${{ github.workspace }}/profraw/dump-%p-%m.profraw"

          TOOL="${{ env.tool_path }}"
          TOTAL=0
          PASS=0
          FAIL=0

          while IFS= read -r icc; do
            TOTAL=$((TOTAL + 1))
            if timeout 10s "$TOOL" "$icc" > /dev/null 2>&1; then
              PASS=$((PASS + 1))
            else
              FAIL=$((FAIL + 1))
            fi
          done < <(find "${{ env.iccdev_root }}/Testing" -name "*.icc" -type f)

          echo "IccDumpProfile: $TOTAL profiles, $PASS pass, $FAIL fail"
          echo "dump_total=$TOTAL" >> $GITHUB_ENV
          echo "dump_pass=$PASS" >> $GITHUB_ENV
          echo "dump_fail=$FAIL" >> $GITHUB_ENV

      - name: Exercise XML round-trip tools
        run: |
          set -euo pipefail
          export LLVM_PROFILE_FILE="${{ github.workspace }}/profraw/xml-%p-%m.profraw"

          BUILD_DIR="${{ env.build_dir }}"
          TO_XML=$(find "$BUILD_DIR" -name "iccToXml" -type f -executable -print -quit)
          FROM_XML=$(find "$BUILD_DIR" -name "iccFromXml" -type f -executable -print -quit)
          ROUNDTRIP=$(find "$BUILD_DIR" -name "iccRoundTrip" -type f -executable -print -quit)

          CONVERTED=0
          # Convert a sample of profiles to XML and back
          mapfile -t ICC_FILES < <(find "${{ env.iccdev_root }}/Testing" -name "*.icc" -type f | shuf -n 50)
          for icc in "${ICC_FILES[@]}"; do
            XML_OUT="/tmp/$(basename "$icc" .icc).xml"
            ICC_OUT="/tmp/$(basename "$icc")"
            if [ -n "$TO_XML" ] && timeout 10s "$TO_XML" "$icc" "$XML_OUT" > /dev/null 2>&1; then
              CONVERTED=$((CONVERTED + 1))
              if [ -n "$FROM_XML" ]; then
                timeout 10s "$FROM_XML" "$XML_OUT" "$ICC_OUT" > /dev/null 2>&1 || true
              fi
            fi
            rm -f "$XML_OUT" "$ICC_OUT"
          done

          # Run roundtrip on sample profiles
          if [ -n "$ROUNDTRIP" ]; then
            mapfile -t RT_FILES < <(find "${{ env.iccdev_root }}/Testing" -name "*.icc" -type f | shuf -n 30)
            for icc in "${RT_FILES[@]}"; do
              timeout 10s "$ROUNDTRIP" "$icc" > /dev/null 2>&1 || true
            done
          fi

          echo "XML round-trip: $CONVERTED conversions complete"

      - name: Merge profdata and generate report
        run: |
          set -euo pipefail
          mkdir -p coverage-report

          # Merge all .profraw files
          PROFRAW_COUNT=$(find "${{ github.workspace }}/profraw" -name "*.profraw" 2>/dev/null | wc -l)
          echo "Found $PROFRAW_COUNT .profraw files"

          if [ "$PROFRAW_COUNT" -eq 0 ]; then
            echo "::error::No profraw files generated â€” coverage instrumentation may have failed"
            exit 1
          fi

          llvm-profdata-18 merge \
            -sparse \
            "${{ github.workspace }}"/profraw/*.profraw \
            -o coverage-report/merged.profdata

          echo "Merged profdata: $(stat -c%s coverage-report/merged.profdata) bytes"

          # Find all instrumented binaries
          BUILD_DIR="${{ env.build_dir }}"
          MAIN_BIN="${{ env.tool_path }}"

          # Build object list for llvm-cov (all tool binaries)
          OBJECT_ARGS=""
          for bin in $(find "$BUILD_DIR" -path "*/Tools/*" -type f -executable); do
            if [ "$bin" != "$MAIN_BIN" ]; then
              OBJECT_ARGS="$OBJECT_ARGS -object=$bin"
            fi
          done

          # Generate text report
          llvm-cov-18 report \
            "$MAIN_BIN" $OBJECT_ARGS \
            -instr-profile=coverage-report/merged.profdata \
            -ignore-filename-regex='(third_party|/usr/|test)' \
            2>&1 | tee coverage-report/coverage-summary.txt

          # Generate HTML report
          llvm-cov-18 show \
            "$MAIN_BIN" $OBJECT_ARGS \
            -instr-profile=coverage-report/merged.profdata \
            -format=html \
            -output-dir=coverage-report/html \
            -show-line-counts-or-regions \
            -show-expansions \
            -ignore-filename-regex='(third_party|/usr/|test)' \
            2>&1 | tail -5

          # Generate lcov-compatible export
          llvm-cov-18 export \
            "$MAIN_BIN" $OBJECT_ARGS \
            -instr-profile=coverage-report/merged.profdata \
            -format=lcov \
            -ignore-filename-regex='(third_party|/usr/|test)' \
            > coverage-report/lcov.info 2>/dev/null || true

          # Summary stats
          if [ -d coverage-report/html ]; then
            HTML_COUNT=$(find coverage-report/html -name "*.html" | wc -l)
            echo "HTML report: $HTML_COUNT files"
          fi
          LCOV_RECORDS=$(grep -c "^SF:" coverage-report/lcov.info 2>/dev/null || echo 0)
          echo "LCOV: $LCOV_RECORDS source file records"

      - name: Report to summary
        if: always()
        run: |
          set -euo pipefail
          source .github/scripts/sanitize-sed.sh 2>/dev/null || true
          {
            echo "## iccDEV Code Coverage Report"
            echo ""
            echo "### Test Execution"
            echo "| Metric | Value |"
            echo "|--------|-------|"
            echo "| ICC Profiles Created | ${{ env.profile_count }} |"
            echo "| IccDumpProfile Total | ${{ env.dump_total }} |"
            echo "| IccDumpProfile Pass | ${{ env.dump_pass }} |"
            echo "| IccDumpProfile Fail | ${{ env.dump_fail }} |"
            echo ""
            echo "### Coverage Summary"
            echo '```'
          } >> $GITHUB_STEP_SUMMARY

          if [ -f coverage-report/coverage-summary.txt ]; then
            cat coverage-report/coverage-summary.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "No coverage data available" >> $GITHUB_STEP_SUMMARY
          fi

          {
            echo '```'
            echo ""
            echo "### Artifacts"
            echo "- \`coverage-report\`: llvm-cov HTML report, lcov.info, text summary"
            echo ""
            echo "### Reference"
            echo "- Workflow: [xsscx/cfl ci-code-coverage.yml](https://github.com/xsscx/cfl/actions/workflows/ci-code-coverage.yml)"
          } >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: coverage-report
          path: coverage-report/
          retention-days: 30
          if-no-files-found: warn
