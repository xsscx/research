###############################################################
# Copyright (c) 2026 David H Hoyt LLC
#
# Intent: Build, package, and publish the ICC Profile MCP Server.
#         Publishes to PyPI, GitHub Releases, and ghcr.io.
#
# Triggers on version tags (v*) pushed to main or mcp branches.
# Can also be run manually via workflow_dispatch.
###############################################################

name: MCP Server Release

permissions:
  contents: write
  packages: write

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      publish_pypi:
        description: 'Publish to PyPI'
        type: boolean
        default: false
      publish_ghcr:
        description: 'Publish Docker image to ghcr.io'
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/icc-profile-mcp

jobs:
  # ── Build & test before any publishing ──────────────────────
  test:
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake clang-18 llvm-18 \
            libxml2-dev libtiff-dev libjpeg-dev libpng-dev \
            zlib1g-dev liblzma-dev nlohmann-json3-dev libssl-dev \
            python3 python3-venv python3-pip

      - name: Build iccDEV (libraries + tools)
        env:
          CC: clang-18
          CXX: clang++-18
        run: |
          set -euo pipefail
          cd iccanalyzer-lite
          git clone --depth 1 https://github.com/InternationalColorConsortium/DemoIccMAX.git iccDEV
          cd iccDEV
          sed -i 's/^  find_package(wxWidgets/#  find_package(wxWidgets/' Build/Cmake/CMakeLists.txt
          sed -i 's/^      ADD_SUBDIRECTORY(Tools\/wxProfileDump)/#      ADD_SUBDIRECTORY(Tools\/wxProfileDump)/' Build/Cmake/CMakeLists.txt
          sed -i 's/^    message(FATAL_ERROR "wxWidgets not found/#    message(FATAL_ERROR "wxWidgets not found/' Build/Cmake/CMakeLists.txt
          cd Build
          cmake Cmake \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_COMPILER=clang-18 \
            -DCMAKE_CXX_COMPILER=clang++-18 \
            -DCMAKE_C_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -g -O1" \
            -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -g -O1 -std=c++17" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined" \
            -DENABLE_TOOLS=ON -DENABLE_STATIC_LIBS=ON -DENABLE_SHARED_LIBS=ON -Wno-dev
          make -j"$(nproc)"

      - name: Build iccanalyzer-lite
        env:
          CXX: clang++-18
        working-directory: iccanalyzer-lite
        run: bash build.sh

      - name: Build colorbleed_tools
        env:
          CC: clang-18
          CXX: clang++-18
        run: |
          set -euo pipefail
          cd colorbleed_tools
          ln -sf ../iccanalyzer-lite/iccDEV iccDEV
          cp ../iccanalyzer-lite/iccDEV/Build/Tools/IccToXml/iccToXml iccToXml
          chmod +x iccToXml
          make clean all CXXFLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -g -O1 -std=gnu++17 -Wall" \
            LINK_LIBS="-fsanitize=address,undefined -lxml2 -lz -llzma -lm"

      - name: Run test suites
        env:
          ASAN_OPTIONS: detect_leaks=0
          MallocNanoZone: "0"
        run: |
          set -euo pipefail
          cd mcp-server
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --quiet -r requirements.txt
          python test_mcp.py
          python test_web_ui.py

  # ── Build Python wheel ──────────────────────────────────────
  build-wheel:
    needs: test
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Build wheel and sdist
        run: |
          set -euo pipefail
          cd mcp-server
          python3 -m pip install --quiet build
          python3 -m build
          ls -lh dist/

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: mcp-server/dist/

  # ── Publish to PyPI ─────────────────────────────────────────
  publish-pypi:
    needs: build-wheel
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_pypi == 'true')
    runs-on: ubuntu-24.04
    environment: pypi
    permissions:
      id-token: write
    steps:
      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/

  # ── GitHub Release ──────────────────────────────────────────
  github-release:
    needs: build-wheel
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Download wheel
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: dist/*

  # ── Docker image → ghcr.io ─────────────────────────────────
  publish-docker:
    needs: test
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_ghcr == 'true')
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
