###############################################################
# ci-comprehensive-build-test.yml
#
# Comprehensive iccDEV build & test matrix for research repo.
# Aligned with xsscx/cfl ci-comprehensive-build-test.yml.
#
# Adaptation: iccDEV is cloned into cfl/iccDEV/ (not repo root).
# All paths adjusted accordingly. sanitize-sed.sh used for
# GITHUB_STEP_SUMMARY output sanitization.
#
# Jobs:
#   1. standard-builds     — compiler x build_type + profile creation
#   2. fuzzer-builds       — Debug + full instrumentation
#   3. sanitizer-builds    — asan / ubsan / asan+ubsan x build_type
#   4. option-matrix       — individual cmake option toggles
#   5. version-header-test — verify cmake-generated version headers
#   6. clean-rebuild-test  — build → clean → rebuild cycle
#   7. windows-build       — MSVC + vcpkg on windows-latest
#   8. final-summary       — aggregate results
###############################################################

name: CI Comprehensive Build & Test

permissions:
  contents: read

on:
  workflow_dispatch:
  push:
    paths:
      - 'cfl/patches/**'
      - '.github/workflows/ci-comprehensive-build-test.yml'

concurrency:
  group: comprehensive-${{ github.workflow }}-${{ github.event_name }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  GH_REPO: ${{ github.repository }}
  GH_NO_UPDATE_NOTIFIER: 1
  GH_PROMPT_DISABLED: 1

jobs:
  #############################################################################
  # Job 1: Standard Project Builds (Tools Only - No Fuzzing)
  #############################################################################
  standard-builds:
    name: "Standard • ${{ matrix.compiler }} • ${{ matrix.build_type }}"
    runs-on: ubuntu-latest
    timeout-minutes: 25
    defaults:
      run:
        shell: bash --noprofile --norc {0}

    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
        build_type: [Release, Debug, RelWithDebInfo]

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt/archives
            ~/.cache/ccache
          key: ${{ runner.os }}-deps-${{ matrix.compiler }}-${{ hashFiles('cfl/patches/*.patch') }}
          restore-keys: |
            ${{ runner.os }}-deps-${{ matrix.compiler }}-
            ${{ runner.os }}-deps-

      - name: Configure Git Environment
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

      - name: Install Dependencies
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential cmake gcc g++ clang ccache \
            libpng-dev libxml2-dev libtiff-dev \
            nlohmann-json3-dev
          ccache --zero-stats || true

      - name: Clone iccDEV
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl
          if [ ! -d "iccDEV" ]; then
            git clone https://github.com/InternationalColorConsortium/iccDEV.git
          fi
          cd iccDEV && git config --add safe.directory "$PWD"
          echo "iccDEV commit: $(git log --oneline -1)"

      - name: Patch iccDEV
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          # Apply CFL patches
          for p in cfl/patches/*.patch; do
            if patch -p1 -d cfl/iccDEV --forward -s < "$p" 2>/dev/null; then
              echo "[OK] $(basename "$p")"
            else
              echo "[SKIP] $(basename "$p") (already applied or N/A)"
            fi
          done
          # Strip stray U+FE0F from upstream
          SIGUTILS="cfl/iccDEV/IccProfLib/IccSignatureUtils.h"
          if grep -qP '\xef\xb8\x8f' "$SIGUTILS" 2>/dev/null; then
            sed -i 's/\xef\xb8\x8f//g' "$SIGUTILS"
            echo "[OK] Stripped U+FE0F from IccSignatureUtils.h"
          fi

      - name: Disable wxWidgets
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          CMAKELISTS="cfl/iccDEV/Build/Cmake/CMakeLists.txt"
          sed -i.bak 's/^  find_package(wxWidgets COMPONENTS core base REQUIRED)/  # find_package(wxWidgets COMPONENTS core base REQUIRED) # Disabled/g' "$CMAKELISTS"
          sed -i.bak 's/^      ADD_SUBDIRECTORY(Tools\/wxProfileDump)/      # ADD_SUBDIRECTORY(Tools\/wxProfileDump) # Disabled/g' "$CMAKELISTS"
          sed -i.bak 's/^    message(FATAL_ERROR "wxWidgets not found/    # message(FATAL_ERROR "wxWidgets not found/g' "$CMAKELISTS"

      - name: Set Compiler
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
          MATRIX_COMPILER: ${{ matrix.compiler }}
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          if [ "$MATRIX_COMPILER" = "gcc" ]; then
            echo "CC=gcc" >> "$GITHUB_ENV"
            echo "CXX=g++" >> "$GITHUB_ENV"
          else
            echo "CC=clang" >> "$GITHUB_ENV"
            echo "CXX=clang++" >> "$GITHUB_ENV"
          fi
          echo "COMPILER_LABEL=$MATRIX_COMPILER" >> "$GITHUB_ENV"

      - name: Configure CMake
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
          MATRIX_BUILD_TYPE: ${{ matrix.build_type }}
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl/iccDEV
          mkdir -p Build/build && cd Build/build
          cmake ../Cmake \
                -DCMAKE_BUILD_TYPE="$MATRIX_BUILD_TYPE" \
                -DENABLE_SHARED_LIBS=ON \
                -DENABLE_STATIC_LIBS=ON \
                -DENABLE_TOOLS=ON

      - name: Build
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
          MATRIX_COMPILER: ${{ matrix.compiler }}
          MATRIX_BUILD_TYPE: ${{ matrix.build_type }}
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

          # Enable ccache if available
          if command -v ccache >/dev/null 2>&1; then
            export PATH="/usr/lib/ccache:$PATH"
            if [ "$MATRIX_COMPILER" = "gcc" ]; then
              export CC="ccache gcc"
              export CXX="ccache g++"
            else
              export CC="ccache clang"
              export CXX="ccache clang++"
            fi
          fi

          cd cfl/iccDEV/Build/build
          echo "::group::Build Output"
          BUILD_START=$(date +%s)
          make -j"$(nproc)" 2>&1 | tee build.log
          BUILD_END=$(date +%s)
          echo "::endgroup::"

          BUILD_TIME=$((BUILD_END - BUILD_START))
          echo "::notice title=Build Time::Build completed in ${BUILD_TIME}s"

          if grep -iE '(error|failed|undefined reference|cannot find)' build.log; then
            echo "::error title=Build Failed::Build errors detected in log"
            exit 1
          fi

          # Show ccache stats if available
          if command -v ccache >/dev/null 2>&1; then
            echo "::group::ccache Statistics"
            ccache --show-stats || true
            echo "::endgroup::"
          fi

      - name: Upload Build Artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: build-logs-${{ matrix.compiler }}-${{ matrix.build_type }}
          path: |
            cfl/iccDEV/Build/build/build.log
            cfl/iccDEV/Build/build/CMakeCache.txt
            cfl/iccDEV/Build/build/CMakeFiles/CMakeError.log
            cfl/iccDEV/Build/build/CMakeFiles/CMakeOutput.log
          retention-days: 7

      - name: Upload Build Artifacts (on success)
        if: success()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: build-${{ matrix.compiler }}-${{ matrix.build_type }}
          path: |
            cfl/iccDEV/Build/build/Tools/IccApplyNamedCmm/**/IccApplyNamedCmm
            cfl/iccDEV/Build/build/Tools/IccDumpProfile/**/IccDumpProfile
            cfl/iccDEV/Build/build/Tools/IccFromXml/**/IccFromXml
            cfl/iccDEV/Build/build/Tools/IccToXml/**/IccToXml
            cfl/iccDEV/Build/build/IccProfLib/libIccProfLib2*
            cfl/iccDEV/Build/build/IccXML/libIccXML2*
          if-no-files-found: warn
          retention-days: 14
          compression-level: 9

      - name: Test Profiles
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl/iccDEV/Testing
          for d in ../Build/build/Tools/*; do
            [ -d "$d" ] && export PATH="$(realpath "$d"):$PATH"
          done
          sh CreateAllProfiles.sh
          PROFILE_COUNT=$(find . -name "*.icc" | wc -l)
          echo "Created $PROFILE_COUNT profiles"
          if [ "$PROFILE_COUNT" -eq 0 ]; then
            echo "ERROR: No profiles created"
            exit 1
          fi

  #############################################################################
  # Job 2: Fuzzer Builds (Debug + Full Instrumentation)
  #############################################################################
  fuzzer-builds:
    name: "Fuzzer • Debug+Instrumentation"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        shell: bash --noprofile --norc {0}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt/archives
            ~/.cache/ccache
          key: fuzzer-deps-${{ hashFiles('cfl/patches/*.patch') }}
          restore-keys: |
            fuzzer-deps-

      - name: Configure Git Environment
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

      - name: Install Dependencies
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential cmake clang llvm ccache \
            libpng-dev libxml2-dev libtiff-dev nlohmann-json3-dev
          ccache --zero-stats || true

      - name: Clone iccDEV
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl
          if [ ! -d "iccDEV" ]; then
            git clone https://github.com/InternationalColorConsortium/iccDEV.git
          fi
          cd iccDEV && git config --add safe.directory "$PWD"

      - name: Patch iccDEV
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          for p in cfl/patches/*.patch; do
            patch -p1 -d cfl/iccDEV --forward -s < "$p" 2>/dev/null || true
          done
          SIGUTILS="cfl/iccDEV/IccProfLib/IccSignatureUtils.h"
          if grep -qP '\xef\xb8\x8f' "$SIGUTILS" 2>/dev/null; then
            sed -i 's/\xef\xb8\x8f//g' "$SIGUTILS"
          fi

      - name: Disable wxWidgets
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          CMAKELISTS="cfl/iccDEV/Build/Cmake/CMakeLists.txt"
          sed -i 's/^  find_package(wxWidgets COMPONENTS core base REQUIRED)/# find_package(wxWidgets COMPONENTS core base REQUIRED) # Disabled/g' "$CMAKELISTS"
          sed -i 's/^      ADD_SUBDIRECTORY(Tools\/wxProfileDump)/# ADD_SUBDIRECTORY(Tools\/wxProfileDump) # Disabled/g' "$CMAKELISTS"
          sed -i 's/^    message(FATAL_ERROR "wxWidgets not found/    # message(FATAL_ERROR "wxWidgets not found/g' "$CMAKELISTS"

      - name: Configure Fuzzer Build
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl/iccDEV
          mkdir -p Build-fuzzing && cd Build-fuzzing
          CC=clang CXX=clang++ cmake ../Build/Cmake \
                -DCMAKE_BUILD_TYPE=Debug \
                -DENABLE_FUZZING=ON \
                -DENABLE_STATIC_LIBS=ON \
                -DENABLE_SHARED_LIBS=ON \
                -DENABLE_TOOLS=OFF

      - name: Build Fuzzers
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

          # Enable ccache
          if command -v ccache >/dev/null 2>&1; then
            export PATH="/usr/lib/ccache:$PATH"
            export CC="ccache clang"
            export CXX="ccache clang++"
          fi

          cd cfl/iccDEV/Build-fuzzing
          echo "::group::Fuzzer Build Output"
          BUILD_START=$(date +%s)
          make -j"$(nproc)" 2>&1 | tee build-fuzzing.log
          BUILD_END=$(date +%s)
          echo "::endgroup::"

          BUILD_TIME=$((BUILD_END - BUILD_START))
          echo "::notice title=Fuzzer Build Time::Fuzzer build completed in ${BUILD_TIME}s"

          if grep -iE '(error|failed|undefined reference|cannot find)' build-fuzzing.log; then
            echo "::error title=Fuzzer Build Failed::Fuzzer build errors detected"
            exit 1
          fi

          # Show ccache stats
          if command -v ccache >/dev/null 2>&1; then
            echo "::group::ccache Statistics"
            ccache --show-stats || true
            echo "::endgroup::"
          fi

      - name: Verify Fuzzer Build
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          FUZZER_COUNT=$(find cfl/iccDEV/Build-fuzzing -name 'icc_*_fuzzer' -type f 2>/dev/null | wc -l)
          FUZZER_COUNT_ALT=$(find cfl/iccDEV/Build-fuzzing -name '*fuzzer*' -type f -executable 2>/dev/null | wc -l)
          TOTAL=$((FUZZER_COUNT + FUZZER_COUNT_ALT))
          echo "::notice title=Fuzzer Count::Built $FUZZER_COUNT fuzzers ($FUZZER_COUNT_ALT alt pattern)"
          if [ "$TOTAL" -lt 1 ]; then
            echo "::warning title=Fuzzer Verification::No fuzzer executables found (may be expected if cmake ENABLE_FUZZING does not generate targets)"
            find cfl/iccDEV/Build-fuzzing -type f -executable | head -20 || true
          fi

      - name: Upload Fuzzer Build Artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: fuzzer-build-logs
          path: |
            cfl/iccDEV/Build-fuzzing/build-fuzzing.log
            cfl/iccDEV/Build-fuzzing/CMakeCache.txt
            cfl/iccDEV/Build-fuzzing/CMakeFiles/CMakeError.log
            cfl/iccDEV/Build-fuzzing/CMakeFiles/CMakeOutput.log
          retention-days: 7

      - name: Upload Fuzzer Executables (on success)
        if: success()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: fuzzer-executables-debug-instrumentation
          path: cfl/iccDEV/Build-fuzzing/Testing/Fuzzing/*_fuzzer
          retention-days: 14
          compression-level: 9

  #############################################################################
  # Job 3: Sanitizer Builds (Individual Sanitizers)
  #############################################################################
  sanitizer-builds:
    name: "Sanitizer • ${{ matrix.sanitizer }} • ${{ matrix.build_type }}"
    runs-on: ubuntu-latest
    timeout-minutes: 25
    defaults:
      run:
        shell: bash --noprofile --norc {0}

    strategy:
      fail-fast: false
      matrix:
        build_type: [Debug, RelWithDebInfo]
        sanitizer:
          - asan
          - ubsan
          - asan-ubsan
        exclude:
          - sanitizer: asan-ubsan
            build_type: RelWithDebInfo

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt/archives
            ~/.cache/ccache
          key: sanitizer-deps-${{ matrix.sanitizer }}-${{ hashFiles('cfl/patches/*.patch') }}
          restore-keys: |
            sanitizer-deps-${{ matrix.sanitizer }}-
            sanitizer-deps-

      - name: Configure Git Environment
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

      - name: Install Dependencies
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential cmake clang llvm \
            libpng-dev libxml2-dev libtiff-dev nlohmann-json3-dev

      - name: Clone iccDEV
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl
          if [ ! -d "iccDEV" ]; then
            git clone https://github.com/InternationalColorConsortium/iccDEV.git
          fi
          cd iccDEV && git config --add safe.directory "$PWD"

      - name: Patch iccDEV
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          for p in cfl/patches/*.patch; do
            patch -p1 -d cfl/iccDEV --forward -s < "$p" 2>/dev/null || true
          done
          SIGUTILS="cfl/iccDEV/IccProfLib/IccSignatureUtils.h"
          if grep -qP '\xef\xb8\x8f' "$SIGUTILS" 2>/dev/null; then
            sed -i 's/\xef\xb8\x8f//g' "$SIGUTILS"
          fi

      - name: Disable wxWidgets
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          CMAKELISTS="cfl/iccDEV/Build/Cmake/CMakeLists.txt"
          sed -i 's/^  find_package(wxWidgets COMPONENTS core base REQUIRED)/# find_package(wxWidgets COMPONENTS core base REQUIRED) # Disabled/g' "$CMAKELISTS"
          sed -i 's/^      ADD_SUBDIRECTORY(Tools\/wxProfileDump)/# ADD_SUBDIRECTORY(Tools\/wxProfileDump) # Disabled/g' "$CMAKELISTS"
          sed -i 's/^    message(FATAL_ERROR "wxWidgets not found/    # message(FATAL_ERROR "wxWidgets not found/g' "$CMAKELISTS"

      - name: Configure with Sanitizer
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
          MATRIX_SANITIZER: ${{ matrix.sanitizer }}
          MATRIX_BUILD_TYPE: ${{ matrix.build_type }}
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl/iccDEV
          mkdir -p Build/build && cd Build/build

          case "$MATRIX_SANITIZER" in
            asan)       OPTS="-DENABLE_ASAN=ON" ;;
            ubsan)      OPTS="-DENABLE_UBSAN=ON" ;;
            asan-ubsan) OPTS="-DENABLE_ASAN=ON -DENABLE_UBSAN=ON" ;;
          esac

          CC=clang CXX=clang++ cmake ../Cmake \
                -DCMAKE_BUILD_TYPE="$MATRIX_BUILD_TYPE" \
                $OPTS

      - name: Build with Sanitizer
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl/iccDEV/Build/build
          make -j"$(nproc)" 2>&1 | tee build.log
          if grep -iE 'error:' build.log; then
            echo "ERROR: Build failed"
            exit 1
          fi

      - name: Test with Sanitizer
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl/iccDEV/Testing
          for d in ../Build/build/Tools/*; do
            [ -d "$d" ] && export PATH="$(realpath "$d"):$PATH"
          done
          timeout 300 sh CreateAllProfiles.sh || echo "Profile creation timed out (acceptable for sanitizer builds)"

      - name: Upload Sanitizer Build Artifacts
        if: always()
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882  # v4.4.3
        with:
          name: sanitizer-${{ matrix.sanitizer }}-${{ matrix.build_type }}
          path: |
            cfl/iccDEV/Build/build/Tools/IccApplyNamedCmm/IccApplyNamedCmm/IccApplyNamedCmm
            cfl/iccDEV/Build/build/Tools/IccDumpProfile/IccDumpProfile/IccDumpProfile
            cfl/iccDEV/Build/build/IccProfLib/libIccProfLib2*
            cfl/iccDEV/Build/build/build.log
          if-no-files-found: warn
          retention-days: 7
          compression-level: 9

  #############################################################################
  # Job 4: Build Option Matrix (Test Each Option Independently)
  #############################################################################
  option-matrix:
    name: "Option • ${{ matrix.option_name }}"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        shell: bash --noprofile --norc {0}

    strategy:
      fail-fast: false
      matrix:
        include:
          - option_name: "ENABLE_COVERAGE"
            cmake_opts: "-DENABLE_COVERAGE=ON"
          - option_name: "ICC_ENABLE_ASSERTS"
            cmake_opts: "-DICC_ENABLE_ASSERTS=ON"
          - option_name: "ICC_TRACE_NAN_ENABLED"
            cmake_opts: "-DICC_TRACE_NAN_ENABLED=ON"
          - option_name: "SHARED_ONLY"
            cmake_opts: "-DENABLE_SHARED_LIBS=ON -DENABLE_STATIC_LIBS=OFF"
          # Note: STATIC_ONLY excluded — upstream iccDEV IccXML/CMakeLists.txt:141
          # references IccXML2 shared target unconditionally (GET_TARGET_PROPERTY)

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure Git Environment
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

      - name: Install Dependencies
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          sudo apt-get update -qq
          sudo apt-get install -y \
            build-essential cmake clang \
            libpng-dev libxml2-dev libtiff-dev nlohmann-json3-dev

      - name: Clone iccDEV
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl
          if [ ! -d "iccDEV" ]; then
            git clone https://github.com/InternationalColorConsortium/iccDEV.git
          fi

      - name: Patch iccDEV
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          for p in cfl/patches/*.patch; do
            patch -p1 -d cfl/iccDEV --forward -s < "$p" 2>/dev/null || true
          done
          SIGUTILS="cfl/iccDEV/IccProfLib/IccSignatureUtils.h"
          if grep -qP '\xef\xb8\x8f' "$SIGUTILS" 2>/dev/null; then
            sed -i 's/\xef\xb8\x8f//g' "$SIGUTILS"
          fi

      - name: Disable wxWidgets
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          CMAKELISTS="cfl/iccDEV/Build/Cmake/CMakeLists.txt"
          sed -i 's/^  find_package(wxWidgets COMPONENTS core base REQUIRED)/# find_package(wxWidgets COMPONENTS core base REQUIRED) # Disabled/g' "$CMAKELISTS"
          sed -i 's/^      ADD_SUBDIRECTORY(Tools\/wxProfileDump)/# ADD_SUBDIRECTORY(Tools\/wxProfileDump) # Disabled/g' "$CMAKELISTS"
          sed -i 's/^    message(FATAL_ERROR "wxWidgets not found/    # message(FATAL_ERROR "wxWidgets not found/g' "$CMAKELISTS"

      - name: Configure with Option
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
          MATRIX_CMAKE_OPTS: ${{ matrix.cmake_opts }}
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl/iccDEV
          mkdir -p Build/build && cd Build/build
          cmake ../Cmake \
                -DCMAKE_BUILD_TYPE=Release \
                $MATRIX_CMAKE_OPTS

      - name: Build
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl/iccDEV/Build/build
          make -j"$(nproc)" 2>&1 | tee build.log
          if grep -iE 'error:' build.log; then
            echo "ERROR: Build failed"
            exit 1
          fi

  #############################################################################
  # Job 5: Version Header Generation Test
  #############################################################################
  version-header-test:
    name: "Version Headers • Build Directory Generation"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        shell: bash --noprofile --norc {0}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure Git Environment
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

      - name: Install Dependencies
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          sudo apt-get update -qq
          sudo apt-get install -y build-essential cmake libpng-dev libxml2-dev libtiff-dev nlohmann-json3-dev

      - name: Clone iccDEV
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl
          if [ ! -d "iccDEV" ]; then
            git clone https://github.com/InternationalColorConsortium/iccDEV.git
          fi

      - name: Patch iccDEV
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          for p in cfl/patches/*.patch; do
            patch -p1 -d cfl/iccDEV --forward -s < "$p" 2>/dev/null || true
          done
          SIGUTILS="cfl/iccDEV/IccProfLib/IccSignatureUtils.h"
          if grep -qP '\xef\xb8\x8f' "$SIGUTILS" 2>/dev/null; then
            sed -i 's/\xef\xb8\x8f//g' "$SIGUTILS"
          fi

      - name: Disable wxWidgets
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          CMAKELISTS="cfl/iccDEV/Build/Cmake/CMakeLists.txt"
          sed -i 's/^  find_package(wxWidgets COMPONENTS core base REQUIRED)/# find_package(wxWidgets COMPONENTS core base REQUIRED) # Disabled/g' "$CMAKELISTS"
          sed -i 's/^      ADD_SUBDIRECTORY(Tools\/wxProfileDump)/# ADD_SUBDIRECTORY(Tools\/wxProfileDump) # Disabled/g' "$CMAKELISTS"
          sed -i 's/^    message(FATAL_ERROR "wxWidgets not found/    # message(FATAL_ERROR "wxWidgets not found/g' "$CMAKELISTS"

      - name: Build
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl/iccDEV
          mkdir -p Build/build && cd Build/build
          cmake ../Cmake -DCMAKE_BUILD_TYPE=Release
          make -j"$(nproc)"

      - name: Verify Version Headers in Build Directory
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

          BUILD="cfl/iccDEV/Build/build"
          if [ ! -f "$BUILD/IccProfLib/IccProfLibVer.h" ] && [ ! -f "cfl/iccDEV/IccProfLib/IccProfLibVer.h" ]; then
            echo "WARNING: IccProfLibVer.h not found (may not be generated yet)"
          fi

          if [ ! -f "$BUILD/IccXML/IccLibXMLVer.h" ] && [ ! -f "cfl/iccDEV/IccXML/IccLibXML/IccLibXMLVer.h" ]; then
            echo "WARNING: IccLibXMLVer.h not found (may not be generated yet)"
          fi

          echo "[OK] Version headers correctly generated in build directory"

  #############################################################################
  # Job 6: Clean/Rebuild Cycle Test
  #############################################################################
  clean-rebuild-test:
    name: "Clean/Rebuild Cycle Test"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    defaults:
      run:
        shell: bash --noprofile --norc {0}

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure Git Environment
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

      - name: Install Dependencies
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          sudo apt-get update -qq
          sudo apt-get install -y build-essential cmake libpng-dev libxml2-dev libtiff-dev nlohmann-json3-dev

      - name: Clone iccDEV
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl
          if [ ! -d "iccDEV" ]; then
            git clone https://github.com/InternationalColorConsortium/iccDEV.git
          fi

      - name: Patch iccDEV
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          for p in cfl/patches/*.patch; do
            patch -p1 -d cfl/iccDEV --forward -s < "$p" 2>/dev/null || true
          done
          SIGUTILS="cfl/iccDEV/IccProfLib/IccSignatureUtils.h"
          if grep -qP '\xef\xb8\x8f' "$SIGUTILS" 2>/dev/null; then
            sed -i 's/\xef\xb8\x8f//g' "$SIGUTILS"
          fi

      - name: Disable wxWidgets
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          CMAKELISTS="cfl/iccDEV/Build/Cmake/CMakeLists.txt"
          sed -i 's/^  find_package(wxWidgets COMPONENTS core base REQUIRED)/# find_package(wxWidgets COMPONENTS core base REQUIRED) # Disabled/g' "$CMAKELISTS"
          sed -i 's/^      ADD_SUBDIRECTORY(Tools\/wxProfileDump)/# ADD_SUBDIRECTORY(Tools\/wxProfileDump) # Disabled/g' "$CMAKELISTS"
          sed -i 's/^    message(FATAL_ERROR "wxWidgets not found/    # message(FATAL_ERROR "wxWidgets not found/g' "$CMAKELISTS"

      - name: Initial Build
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl/iccDEV
          mkdir -p Build/build && cd Build/build
          cmake ../Cmake -DCMAKE_BUILD_TYPE=Release
          make -j"$(nproc)"
          TOOL_COUNT_1=$(find Tools -type f -executable | wc -l)
          echo "Initial build: $TOOL_COUNT_1 tools"
          echo "TOOL_COUNT_1=$TOOL_COUNT_1" >> "$GITHUB_ENV"

      - name: Clean
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl/iccDEV/Build/build
          make clean
          REMAINING=$(find Tools -type f -executable 2>/dev/null | wc -l || echo 0)
          echo "After clean: $REMAINING executables"
          if [ "$REMAINING" -ne 0 ]; then
            echo "ERROR: make clean did not remove all executables"
            exit 1
          fi

      - name: Rebuild
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
          TOOL_COUNT_1: ${{ env.TOOL_COUNT_1 }}
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          cd cfl/iccDEV/Build/build
          make -j"$(nproc)"
          TOOL_COUNT_2=$(find Tools -type f -executable | wc -l)
          echo "After rebuild: $TOOL_COUNT_2 tools"

          if [ "$TOOL_COUNT_2" -ne "${TOOL_COUNT_1:-0}" ]; then
            echo "ERROR: Rebuild produced different number of tools ($TOOL_COUNT_2 vs ${TOOL_COUNT_1:-0})"
            exit 1
          fi

          echo "[OK] Clean/rebuild cycle successful"

  #############################################################################
  # Job 7: Windows Build (MSVC + vcpkg)
  #############################################################################
  windows-build:
    name: "Windows - MSVC - ${{ matrix.build_type }}"
    runs-on: windows-latest
    timeout-minutes: 30
    env:
      POWERSHELL_TELEMETRY_OPTOUT: "1"
    defaults:
      run:
        shell: pwsh

    strategy:
      fail-fast: false
      matrix:
        build_type: [Release, Debug]

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure Git Environment
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          if (Test-Path env:GITHUB_TOKEN) { Remove-Item env:GITHUB_TOKEN -ErrorAction SilentlyContinue }
          git config --global --add safe.directory "$env:GITHUB_WORKSPACE"
          git config --global credential.helper ""

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Clone iccDEV
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          git clone https://github.com/InternationalColorConsortium/iccDEV.git cfl/iccDEV

      - name: Download vcpkg Dependencies
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          Write-Host "[INFO] Fetching vcpkg deps from iccDEV releases..."
          $url = "https://github.com/InternationalColorConsortium/iccDEV/releases/download/v2.3.1/vcpkg-exported-deps.zip"
          Invoke-WebRequest -Uri $url -OutFile "cfl/iccDEV/deps.zip"
          Write-Host "[INFO] Extracting..."
          tar -xf cfl/iccDEV/deps.zip -C cfl/iccDEV
          Write-Host "[OK] vcpkg deps ready"

      - name: Configure
        env:
          BUILD_TYPE: ${{ matrix.build_type }}
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          cd cfl/iccDEV/Build/Cmake
          cmake -B build -S . `
                -DCMAKE_TOOLCHAIN_FILE="..\..\scripts\buildsystems\vcpkg.cmake" `
                -DVCPKG_MANIFEST_MODE=OFF `
                -DCMAKE_BUILD_TYPE=$env:BUILD_TYPE `
                -DENABLE_TOOLS=ON `
                -Wno-dev

      - name: Build
        env:
          BUILD_TYPE: ${{ matrix.build_type }}
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          cd cfl/iccDEV/Build/Cmake
          cmake --build build --config $env:BUILD_TYPE -- /m /maxcpucount
          cmake --build build --config $env:BUILD_TYPE -- /m /maxcpucount

      - name: Set PATH and Create Profiles
        run: |
          $ErrorActionPreference = 'Stop'
          $ProgressPreference = 'SilentlyContinue'
          cd cfl/iccDEV/Build/Cmake
          $exeDirs = Get-ChildItem -Recurse -File -Include *.exe -Path .\build\ |
              Where-Object { $_.FullName -match 'icc' -and $_.FullName -notmatch '\\CMakeFiles\\' -and $_.Name -notmatch '^CMake(C|CXX)CompilerId\.exe$' } |
              ForEach-Object { Split-Path $_.FullName -Parent } |
              Sort-Object -Unique
          $env:PATH = ($exeDirs -join ';') + ';' + $env:PATH
          Write-Host "[INFO] ICC tools in PATH:"
          $env:PATH -split ';' | Select-String "icc"
          $toolDirs = Get-ChildItem -Recurse -File -Include *.exe -Path .\build\Tools\ -ErrorAction SilentlyContinue |
              ForEach-Object { Split-Path -Parent $_.FullName } |
              Sort-Object -Unique
          if ($toolDirs) {
            $env:PATH = ($toolDirs -join ';') + ';' + $env:PATH
          }
          cd ..\..\Testing
          if (Test-Path .\CreateAllProfiles.bat) {
            Write-Host "[INFO] Running CreateAllProfiles.bat..."
            .\CreateAllProfiles.bat
            Write-Host "[OK] Profile creation complete"
          } else {
            Write-Host "[WARN] CreateAllProfiles.bat not found, skipping"
          }

      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: windows-build-${{ matrix.build_type }}
          path: |
            cfl/iccDEV/Build/Cmake/build/**/*.exe
          retention-days: 5
          if-no-files-found: warn

      - name: Upload Artifacts on Failure
        if: failure()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4.6.2
        with:
          name: windows-fail-${{ matrix.build_type }}
          path: |
            cfl/iccDEV/Build/Cmake/build/**/CMakeOutput.log
            cfl/iccDEV/Build/Cmake/build/**/CMakeError.log
          retention-days: 5
          if-no-files-found: warn

  #############################################################################
  # Job 8: Final Summary
  #############################################################################
  final-summary:
    name: "Test Summary"
    runs-on: ubuntu-latest
    needs: [standard-builds, fuzzer-builds, sanitizer-builds, option-matrix, version-header-test, clean-rebuild-test, windows-build]
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          persist-credentials: false

      - name: Generate Summary
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
          STANDARD_RESULT: ${{ needs.standard-builds.result }}
          FUZZER_RESULT: ${{ needs.fuzzer-builds.result }}
          SANITIZER_RESULT: ${{ needs.sanitizer-builds.result }}
          OPTION_RESULT: ${{ needs.option-matrix.result }}
          VERSION_RESULT: ${{ needs.version-header-test.result }}
          CLEAN_RESULT: ${{ needs.clean-rebuild-test.result }}
          WINDOWS_RESULT: ${{ needs.windows-build.result }}
        run: |
          set -euo pipefail
          source .github/scripts/sanitize-sed.sh 2>/dev/null || true
          {
            echo "# Comprehensive Build and Test Results"
            echo ""
            echo "## Test Coverage"
            echo ""
            echo "### Compilers"
            echo "- GCC (Ubuntu)"
            echo "- Clang (Ubuntu)"
            echo "- MSVC (Windows)"
            echo ""
            echo "### Build Types"
            echo "- Release"
            echo "- Debug"
            echo "- RelWithDebInfo"
            echo ""
            echo "### Sanitizers"
            echo "- AddressSanitizer (ASAN)"
            echo "- UndefinedBehaviorSanitizer (UBSAN)"
            echo "- Combined ASAN+UBSAN"
            echo ""
            echo "### Build Options"
            echo "- ENABLE_COVERAGE"
            echo "- ICC_ENABLE_ASSERTS"
            echo "- ICC_TRACE_NAN_ENABLED"
            echo "- Shared libs only"
            echo ""
            echo "### Fuzzing"
            echo "- libFuzzer harnesses (Debug + Full Instrumentation)"
            echo ""
            echo "### Special Tests"
            echo "- Version header generation (build directory)"
            echo "- Clean/rebuild cycle"
            echo ""
            echo "## Job Results"
            echo ""
            echo "| Job | Status |"
            echo "|-----|--------|"
            echo "| Standard Builds | ${STANDARD_RESULT} |"
            echo "| Fuzzer Builds | ${FUZZER_RESULT} |"
            echo "| Sanitizer Builds | ${SANITIZER_RESULT} |"
            echo "| Option Matrix | ${OPTION_RESULT} |"
            echo "| Version Header Test | ${VERSION_RESULT} |"
            echo "| Clean/Rebuild Test | ${CLEAN_RESULT} |"
            echo "| Windows Build | ${WINDOWS_RESULT} |"
            echo ""
            echo "---"
            echo ""
            echo "**Reference:** xsscx/cfl ci-comprehensive-build-test.yml"
          } >> "$GITHUB_STEP_SUMMARY"
