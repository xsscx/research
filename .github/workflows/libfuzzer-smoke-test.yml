###############################################################
# Copyright (c) 2026 David H Hoyt LLC
#
# Intent: LibFuzzer smoke test - 60s per fuzzer with matrix
#
# Based on: xsscx/cfl actions/runs/21781371436 (known good SUCCESS)
# Pattern: cfl/ has fuzzer sources, clone iccDEV as subproject,
#          build libs with sanitizers, compile fuzzers with -I/-L
#
# Migrated: 2026-02-07 by GitHub Copilot CLI
#           Under llmcjf/ governance surveillance
###############################################################

name: LibFuzzer Smoke Test (60s)

permissions:
  contents: write

on:
  workflow_dispatch:

concurrency:
  group: libfuzzer-smoke-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-fuzzers:
    name: "Build Fuzzers"
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    defaults:
      run:
        shell: bash --noprofile --norc {0}

    outputs:
      fuzzers: ${{ steps.list-fuzzers.outputs.fuzzers }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          persist-credentials: false
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Cache APT packages
        id: cache-apt
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: ${{ runner.os }}-apt-${{ hashFiles(format('.github/workflows/{0}', github.workflow_ref)) }}

      - name: Install dependencies
        env:
          BASH_ENV: /dev/null
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

          if [ "${{ steps.cache-apt.outputs.cache-hit }}" != 'true' ]; then
            sudo apt-get update -qq
          else
            echo "Using cached APT packages"
          fi
          sudo apt-get install -y --no-install-recommends \
            build-essential cmake clang clang-tools \
            libxml2-dev libtiff-dev libpng-dev zlib1g-dev \
            nlohmann-json3-dev libssl-dev llvm

          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV

      - name: Cache iccDEV repository
        id: cache-iccdev
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4
        with:
          path: cfl/iccDEV
          key: ${{ runner.os }}-iccdev-cfl-${{ hashFiles('cfl/patches/*.patch') }}

      - name: Clone iccDEV into cfl/
        if: steps.cache-iccdev.outputs.cache-hit != 'true'
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

          cd cfl
          if [ ! -d "iccDEV" ]; then
            git clone --depth 1 https://github.com/InternationalColorConsortium/iccDEV.git
          fi

      - name: Cache iccDEV build artifacts
        id: cache-iccdev-build
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4
        with:
          path: |
            cfl/iccDEV/Build/IccProfLib
            cfl/iccDEV/Build/IccXML
            cfl/iccDEV/Build/CMakeCache.txt
            cfl/iccDEV/Build/CMakeFiles
          key: ${{ runner.os }}-iccdev-build-cfl-${{ hashFiles('cfl/patches/*.patch') }}

      - name: Apply CFL patches to iccDEV
        if: steps.cache-iccdev-build.outputs.cache-hit != 'true'
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          echo "Applying CFL library patches..."
          for p in cfl/patches/*.patch; do
            if patch -p1 -d cfl/iccDEV --forward -s < "$p" 2>/dev/null; then
              echo "  [OK] $(basename "$p")"
            else
              echo "  [SKIP]  $(basename "$p") (already applied or N/A)"
            fi
          done
          # Strip stray U+FE0F (emoji variation selector) from upstream source
          SIGUTILS="cfl/iccDEV/IccProfLib/IccSignatureUtils.h"
          if grep -qP '\xef\xb8\x8f' "$SIGUTILS" 2>/dev/null; then
            sed -i 's/\xef\xb8\x8f//g' "$SIGUTILS"
            echo "[OK] Stripped stray U+FE0F from IccSignatureUtils.h"
          fi

      - name: Build iccDEV libraries (Debug)
        if: steps.cache-iccdev-build.outputs.cache-hit != 'true'
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

          cd cfl/iccDEV

          sed -i 's/^  find_package(wxWidgets/#  find_package(wxWidgets/' Build/Cmake/CMakeLists.txt
          sed -i 's/^      ADD_SUBDIRECTORY(Tools\/wxProfileDump)/#      ADD_SUBDIRECTORY(Tools\/wxProfileDump)/' Build/Cmake/CMakeLists.txt
          sed -i 's/^    message(FATAL_ERROR "wxWidgets not found/#    message(FATAL_ERROR "wxWidgets not found/' Build/Cmake/CMakeLists.txt

          cd Build
          cmake Cmake/ \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            -DCMAKE_BUILD_TYPE=Debug \
            -DCMAKE_C_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -fprofile-instr-generate -fcoverage-mapping" \
            -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer -fprofile-instr-generate -fcoverage-mapping" \
            -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined -fprofile-instr-generate" \
            -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=address,undefined -fprofile-instr-generate" \
            -DENABLE_STATIC_LIBS=ON \
            -DENABLE_TOOLS=OFF \
            -DICC_LOG_SAFE=ON \
            -DICC_TRACE_NAN_ENABLED=ON \
            -Wno-dev

          make -j$(nproc) IccProfLib2-static IccXML2-static

      - name: Build TiffImg.o
        run: |
          set -euo pipefail
          ICCDEV="$PWD/cfl/iccDEV"
          clang++ -fsanitize=address,undefined -fno-omit-frame-pointer -g -O1 -frtti \
            -I${ICCDEV}/IccProfLib \
            -I${ICCDEV}/Tools/CmdLine/IccCommon \
            -I${ICCDEV}/Tools/CmdLine/IccApplyProfiles \
            -I/usr/include/libxml2 \
            -c ${ICCDEV}/Tools/CmdLine/IccApplyProfiles/TiffImg.cpp \
            -o cfl/TiffImg.o || echo "WARN: TiffImg.o build failed, tiff fuzzers may skip"

      - name: Build all fuzzers
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

          ICCDEV="$PWD/cfl/iccDEV"
          CFL="$PWD/cfl"
          BUILD="$ICCDEV/Build"
          OUTDIR="$PWD/cfl/bin"
          mkdir -p "$OUTDIR"

          CXXFLAGS="-fsanitize=fuzzer,address,undefined -fno-omit-frame-pointer -g -O1 -frtti -fprofile-instr-generate -fcoverage-mapping"
          INCLUDES="-I$ICCDEV/IccProfLib -I$ICCDEV/IccXML/IccLibXML -I$ICCDEV/Tools/CmdLine/IccCommon -I$ICCDEV/Tools/CmdLine/IccApplyProfiles -I/usr/include/libxml2"
          LIBS_BASE="$BUILD/IccProfLib/libIccProfLib2-static.a"
          LIBS_XML="$BUILD/IccXML/libIccXML2-static.a"
          LIBS_SYS="-lxml2 -lz"

          # Fuzzers that need TiffImg.o and libtiff
          TIFF_FUZZERS="icc_applyprofiles_fuzzer icc_tiffdump_fuzzer icc_specsep_fuzzer"

          BUILT=0
          for src in "$CFL"/*_fuzzer.cpp; do
            FNAME=$(basename "$src" .cpp)
            EXTRA_OBJ=""
            EXTRA_LIBS=""
            EXTRA_LDFLAGS=""
            if echo "$TIFF_FUZZERS" | grep -qw "$FNAME"; then
              if [ -f "$CFL/TiffImg.o" ]; then
                EXTRA_OBJ="$CFL/TiffImg.o"
                EXTRA_LIBS="-ltiff"
              fi
            fi
            if [ "$FNAME" = "icc_deep_dump_fuzzer" ]; then
              EXTRA_LDFLAGS="-Wl,--allow-multiple-definition"
            fi
            set +e
            clang++ $CXXFLAGS $INCLUDES "$src" \
              $EXTRA_OBJ $LIBS_BASE $LIBS_XML $LIBS_SYS $EXTRA_LIBS $EXTRA_LDFLAGS \
              -o "$OUTDIR/$FNAME" 2>&1
            RC=$?
            set -e
            if [ $RC -eq 0 ]; then
              echo "OK: $FNAME"
              BUILT=$((BUILT + 1))
            else
              echo "SKIP: $FNAME (exit $RC)"
            fi
          done

          echo "Built $BUILT fuzzers"
          ls "$OUTDIR"/*_fuzzer

      - name: List built fuzzers
        id: list-fuzzers
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true

          cd cfl/bin
          # Exclude deep_dump and spectral fuzzers: long-running, causes runner timeouts
          FUZZERS=$(ls *_fuzzer 2>/dev/null | grep -v -e icc_deep_dump_fuzzer -e icc_spectral_fuzzer | python3 -c "import sys,json; print(json.dumps([l.strip() for l in sys.stdin]))")
          echo "fuzzers=$FUZZERS" >> $GITHUB_OUTPUT
          echo "Fuzzers for matrix: $FUZZERS"

      - name: Upload fuzzer binaries
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: fuzzer-binaries
          path: |
            cfl/bin/*_fuzzer
            cfl/*.dict
            cfl/*_seed_corpus/
          retention-days: 1

  smoke-test:
    name: "Smoke - ${{ matrix.fuzzer }}"
    needs: build-fuzzers
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        fuzzer: ${{ fromJson(needs.build-fuzzers.outputs.fuzzers) }}
    defaults:
      run:
        shell: bash --noprofile --norc {0}

    steps:
      - name: Checkout scripts
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          persist-credentials: false
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false
          fetch-depth: 1

      - name: Download fuzzer binaries
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4
        with:
          name: fuzzer-binaries

      - name: Run fuzzer (60s)
        env:
          BASH_ENV: /dev/null
          ASAN_OPTIONS: "symbolize=1:print_stacktrace=1:detect_stack_use_after_return=1:check_initialization_order=1:strict_init_order=1:detect_invalid_pointer_pairs=2:allocator_may_return_null=1:detect_leaks=0:quarantine_size_mb=256"
          UBSAN_OPTIONS: "symbolize=1:print_stacktrace=1:halt_on_error=0:report_error_type=1"
        run: |
          set -euo pipefail
          source .github/scripts/sanitize-sed.sh 2>/dev/null || true

          chmod +x "bin/${{ matrix.fuzzer }}"
          mkdir -p corpus

          # Check for dictionary
          DICT_ARG=""
          FNAME="${{ matrix.fuzzer }}"
          if [ -f "${FNAME}.dict" ]; then
            DICT_ARG="-dict=${FNAME}.dict"
          elif [ -f "icc_core.dict" ]; then
            DICT_ARG="-dict=icc_core.dict"
          fi

          # Check for seed corpus
          SEED_DIR=""
          if [ -d "${FNAME}_seed_corpus" ]; then
            SEED_DIR="${FNAME}_seed_corpus"
          fi

          # Enable deep dump diagnostics for icc_deep_dump_fuzzer
          if [ "${{ matrix.fuzzer }}" = "icc_deep_dump_fuzzer" ]; then
            export DEEP_DUMP_DIAG=1
          fi

          set +e
          timeout --kill-after=5s 65s "bin/${{ matrix.fuzzer }}" \
            -max_total_time=60 \
            -print_final_stats=1 \
            -detect_leaks=0 \
            -rss_limit_mb=4096 \
            -timeout=30 \
            $DICT_ARG \
            corpus $SEED_DIR 2>&1 | tee /tmp/fuzz-output.log
          EXIT_CODE=$?
          set -e

          {
            echo "### ${{ matrix.fuzzer }}"
            echo ""
            if [ $EXIT_CODE -eq 0 ] || [ $EXIT_CODE -eq 124 ]; then
              echo "**Status:** PASS (exit: $EXIT_CODE)"
            else
              echo "**Status:** FAIL (exit: $EXIT_CODE)"
            fi
            echo "**Duration:** 60s"
          } >> $GITHUB_STEP_SUMMARY

          # Collect crash artifacts
          CRASHES=$(find . -name "crash-*" -o -name "leak-*" -o -name "oom-*" 2>/dev/null | wc -l)
          if [ "$CRASHES" -gt 0 ]; then
            echo "**Crashes found:** $CRASHES" >> $GITHUB_STEP_SUMMARY
            mkdir -p crash-artifacts
            find . -name "crash-*" -exec cp {} crash-artifacts/ \; 2>/dev/null || true
            find . -name "leak-*" -exec cp {} crash-artifacts/ \; 2>/dev/null || true
            find . -name "oom-*" -exec cp {} crash-artifacts/ \; 2>/dev/null || true
          fi

      - name: Extract recommended dict entries
        if: always()
        run: |
          mkdir -p dict-updates
          if [ -f /tmp/fuzz-output.log ]; then
            python3 .github/scripts/convert-libfuzzer-dict.py \
              /tmp/fuzz-output.log \
              "dict-updates/${{ matrix.fuzzer }}.dict" 2>&1 || true
            if [ -f "dict-updates/${{ matrix.fuzzer }}.dict" ]; then
              COUNT=$(grep -c '^"' "dict-updates/${{ matrix.fuzzer }}.dict" 2>/dev/null || echo 0)
              echo "[INFO] Extracted ${COUNT} recommended dict entries for ${{ matrix.fuzzer }}"
            fi
          fi

      - name: Upload crash artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: crash-${{ matrix.fuzzer }}-${{ github.run_id }}
          path: crash-artifacts/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload dict updates
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: dict-${{ matrix.fuzzer }}-${{ github.run_id }}
          path: dict-updates/
          retention-days: 30
          if-no-files-found: ignore

  update-dicts:
    name: "Update Dictionaries"
    needs: smoke-test
    if: always() && needs.smoke-test.result == 'success'
    runs-on: ubuntu-24.04
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          ref: ${{ github.ref }}
          token: ${{ github.token }}

      - name: Download all dict artifacts
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4
        with:
          pattern: dict-*
          path: dict-artifacts/
          merge-multiple: false

      - name: Merge dict entries into cfl/*.dict
        run: |
          set -euo pipefail
          UPDATED=0
          TOTAL_NEW=0

          echo "=== Dictionary Merge ==="
          for dir in dict-artifacts/*/; do
            [ -d "$dir" ] || continue
            for dict_file in "$dir"*.dict; do
              [ -f "$dict_file" ] || continue
              FUZZER=$(basename "$dict_file" .dict)
              TARGET="cfl/${FUZZER}.dict"

              # Count new entries before merge
              NEW=$(python3 .github/scripts/convert-libfuzzer-dict.py \
                "$dict_file" "$TARGET" --append --dry-run 2>&1 | \
                grep -oP 'New:\s+\K[0-9]+' || echo 0)

              if [ "$NEW" -gt 0 ]; then
                python3 .github/scripts/convert-libfuzzer-dict.py \
                  "$dict_file" "$TARGET" --append
                echo "  [OK] ${FUZZER}: +${NEW} entries â†’ ${TARGET}"
                UPDATED=$((UPDATED + 1))
                TOTAL_NEW=$((TOTAL_NEW + NEW))
              else
                echo "  [SKIP]  ${FUZZER}: no new entries"
              fi
            done
          done

          echo ""
          echo "Updated $UPDATED dict files with $TOTAL_NEW new entries total"
          echo "DICT_UPDATED=$UPDATED" >> $GITHUB_ENV
          echo "DICT_NEW_ENTRIES=$TOTAL_NEW" >> $GITHUB_ENV

      - name: Commit updated dictionaries
        if: env.DICT_UPDATED != '0'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add cfl/*.dict
          git commit -m "chore(dicts): auto-merge ${DICT_NEW_ENTRIES} recommended entries from run ${{ github.run_id }}

          Updated ${DICT_UPDATED} dictionary files with LibFuzzer recommended entries.
          Source: LibFuzzer Smoke Test run ${{ github.run_id }}

          Co-authored-by: Copilot <223556219+Copilot@users.noreply.github.com>"
          git push
