###############################################################
#
# Copyright (c) 2025-2026 International Color Consortium. 
#                 All rights reserved. 
#                 https://color.org
#
#
# Intent: ci-docker-latest
#
# Last Updated: 2026-02-13 15:58:30 UTC UTC by David Hoyt 
#               Apply Hoyt's BASH Shell Prologue
#
#
#
#
#  
#
###############################################################
# Intent: Build and publish iccDEV Docker container Release
###############################################################

name: ci-docker-latest

permissions:
  contents: read
  packages: write
  id-token: write
  attestations: write

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'Dockerfile.instrumented'
      - '.github/workflows/ci-docker-latest.yml'

jobs:
  build:
    name: "Build iccDEV Docker"
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ghcr.io/${{ github.repository_owner }}/iccdev-latest
          tags: |
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}
      - name: Log in to GHCR
        if: github.event_name != 'pull_request'
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        id: build-push
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8 # v6.19.2
        with:
          context: .
          file: ./Dockerfile.instrumented
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: mode=max
          sbom: true

      - name: Generate SBOM
        if: github.event_name != 'pull_request'
        uses: anchore/sbom-action@2d094306a78d7bde297684f0120dfb41969c38c2 # v0.22.2
        with:
          image: ghcr.io/${{ github.repository_owner }}/iccdev-latest@${{ steps.build-push.outputs.digest }}
          format: spdx-json
          output-file: sbom.spdx.json

      - name: Attest build provenance
        if: github.event_name != 'pull_request'
        uses: actions/attest-build-provenance@c44148e5bf178192efd8947e07a0d439a356c60b # v3.2.0
        with:
          subject-name: ghcr.io/${{ github.repository_owner }}/iccdev-latest
          subject-digest: ${{ steps.build-push.outputs.digest }}
          push-to-registry: true

      - name: Attest SBOM
        if: github.event_name != 'pull_request'
        uses: actions/attest-sbom@b74e95116c27d38263fc426c93ebfca07aa6197b # v3.0.0
        with:
          subject-name: ghcr.io/${{ github.repository_owner }}/iccdev-latest
          subject-digest: ${{ steps.build-push.outputs.digest }}
          sbom-path: sbom.spdx.json
          push-to-registry: true

      - name: Upload SBOM
        if: github.event_name != 'pull_request'
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: iccdev-latest-sbom
          path: sbom.spdx.json
          retention-days: 90

      - name: Build local test image
        run: docker build -f Dockerfile.instrumented -t iccdev-test:latest .

      - name: Verify tools
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          unset GITHUB_TOKEN || true
          TOOL_COUNT=$(docker run --rm iccdev-test:latest bash -c \
            'find /opt/iccdev/Build/Tools -type f -executable | wc -l')
          echo "Tools built: $TOOL_COUNT"
          if [ "$TOOL_COUNT" -lt 12 ]; then
            echo "::error::Expected at least 12 tools, found $TOOL_COUNT"
            exit 1
          fi
          MISSING=$(docker run --rm iccdev-test:latest bash -c \
            'ldd /opt/iccdev/Build/Tools/IccToXml/iccToXml 2>&1 | grep -c "not found" || true')
          if [ "$MISSING" != "0" ]; then
            echo "::error::Missing runtime shared libraries"
            docker run --rm iccdev-test:latest bash -c \
              'ldd /opt/iccdev/Build/Tools/IccToXml/iccToXml 2>&1 | grep "not found"'
            exit 1
          fi
          echo "### Build Results" >> "$GITHUB_STEP_SUMMARY"
          echo "- Tools: $TOOL_COUNT" >> "$GITHUB_STEP_SUMMARY"
          echo "- Runtime deps: All resolved ✅" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          docker run --rm iccdev-test:latest bash -c \
            'find /opt/iccdev/Build/Tools -type f -executable -exec basename {} \; | sort' \
            >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
      - name: Test tool execution
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          unset GITHUB_TOKEN || true
          FAILURES=0
          echo "### Tool Tests" >> "$GITHUB_STEP_SUMMARY"
          for tool in iccToXml iccFromXml iccDumpProfile iccRoundTrip; do
            OUT=$(docker run --rm iccdev-test:latest "$tool" 2>&1 || true)
            if echo "$OUT" | grep -qiE "Usage:|IccProfLib"; then
              echo "✅ $tool" >> "$GITHUB_STEP_SUMMARY"
            else
              echo "::error::Tool test failed: $tool"
              echo "❌ $tool" >> "$GITHUB_STEP_SUMMARY"
              FAILURES=$((FAILURES + 1))
            fi
          done
          if [ "$FAILURES" -gt 0 ]; then
            echo "::error::$FAILURES tool test(s) failed"
            exit 1
          fi
      - name: Test iccToXml profile conversion
        shell: bash --noprofile --norc {0}
        env:
          BASH_ENV: /dev/null
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          unset GITHUB_TOKEN || true
          echo "### iccToXml Profile Conversion" >> "$GITHUB_STEP_SUMMARY"
          docker run --rm iccdev-test:latest bash -c '
            set -euo pipefail
            cd /opt/iccdev
            iccToXml Testing/sRGB_v4_ICC_preference.icc /tmp/sRGB_v4.xml
            test -s /tmp/sRGB_v4.xml || { echo "ERROR: output XML is empty"; exit 1; }
            ls -lh /tmp/sRGB_v4.xml
            echo "=== First 20 lines of XML output ==="
            head -20 /tmp/sRGB_v4.xml
          ' 2>&1 | tee /tmp/iccToXml-output.txt
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat /tmp/iccToXml-output.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
      - name: Cleanup
        if: always()
        run: docker rmi iccdev-test:latest || true
