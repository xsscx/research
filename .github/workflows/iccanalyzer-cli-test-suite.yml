###############################################################
# Copyright (c) 2026 David H Hoyt LLC
#
# Intent: Comprehensive CLI argument testing for iccAnalyzer-lite
#         Tests all command modes: -h, -r, -a, -n
#
# Reference: https://github.com/xsscx/research/actions/runs/21790146700
#            (iccAnalyzer-lite Extended Testing - Known Good)
#
# CLI Arguments Under Test:
#   -h <file.icc>   Security heuristics analysis
#   -r <file.icc>   Round-trip accuracy test  
#   -a <file.icc>   Comprehensive analysis (all modes)
#   -n <file.icc>   Ninja mode (minimal output)
#   -nf <file.icc>  Ninja mode (full dump, no truncation)
# 
# Note: -x extraction mode requires basename parameter, tested separately
#
###############################################################

name: iccAnalyzer CLI Test Suite

permissions:
  contents: read
  security-events: write

on:
  workflow_dispatch:
    inputs:
      test_profile_count:
        description: 'Number of test profiles to use (max 50)'
        required: false
        default: '25'
        type: string
      include_malformed:
        description: 'Include potentially malformed profiles'
        required: false
        default: true
        type: boolean
  schedule:
    - cron: '0 6 * * *'  # Daily at 06:00 UTC

concurrency:
  group: iccanalyzer-cli-test-${{ github.ref }}
  cancel-in-progress: true

env:
  TEST_PROFILE_COUNT: ${{ github.event.inputs.test_profile_count || '25' }}
  INCLUDE_MALFORMED: ${{ github.event.inputs.include_malformed || 'true' }}
  TOTAL_MODES: 5  # Updated to include ninja-full mode

jobs:
  cli-test-suite:
    name: "Build & Test All CLI Modes"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        shell: bash --noprofile --norc {0}

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          persist-credentials: false
          submodules: recursive
          fetch-depth: 1

      - name: Install dependencies
        env:
          BASH_ENV: /dev/null
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            clang \
            libxml2-dev \
            libtiff-dev \
            libjpeg-dev \
            libpng-dev \
            zlib1g-dev \
            liblzma-dev \
            nlohmann-json3-dev \
            libssl-dev \
            lcov

      - name: Clone iccDEV dependency
        env:
          BASH_ENV: /dev/null
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          
          cd iccanalyzer-lite
          git clone https://github.com/InternationalColorConsortium/iccDEV.git
          cd iccDEV
          
          echo "iccDEV cloned at: $(pwd)"
          echo "iccDEV commit: $(git log --oneline -1)"

      - name: Build iccDEV libraries with full instrumentation
        env:
          BASH_ENV: /dev/null
          DEBIAN_FRONTEND: noninteractive
          CXX: clang++
        run: |
          set -euo pipefail
          git config --add safe.directory "$PWD"
          git config --global credential.helper ""
          unset GITHUB_TOKEN || true
          
          cd iccanalyzer-lite/iccDEV/Build
          
          echo "Configuring CMake with full instrumentation..."
          cmake Cmake \
            -DCMAKE_BUILD_TYPE=Debug \
            -DENABLE_ASAN=ON \
            -DENABLE_UBSAN=ON \
            -DENABLE_COVERAGE=ON \
            -DENABLE_TOOLS=OFF \
            -Wno-dev
          
          echo "Building libraries with $(nproc) cores..."
          make -j$(nproc)
          
          echo "Verifying instrumented libraries..."
          ls -lh IccProfLib/libIccProfLib2-static.a
          ls -lh IccXML/libIccXML2-static.a

      - name: Build iccanalyzer-lite
        working-directory: iccanalyzer-lite
        run: |
          bash build.sh

      - name: Verify binary
        working-directory: iccanalyzer-lite
        run: |
          ls -lh iccanalyzer-lite
          file iccanalyzer-lite
          ./iccanalyzer-lite --version

      - name: Setup test profiles
        id: setup
        run: |
          set -euo pipefail
          mkdir -p cli-test-results/outputs
          
          PROFILE_COUNT=${{ env.TEST_PROFILE_COUNT }}
          PROFILE_COUNT=$((PROFILE_COUNT > 50 ? 50 : PROFILE_COUNT))
          
          find test-profiles/ -type f -name "*.icc" | \
            shuf -n ${PROFILE_COUNT} > cli-test-results/selected-profiles.txt
          
          AVAILABLE=$(wc -l < cli-test-results/selected-profiles.txt | tr -d ' \n\r')
          echo "test_count=${AVAILABLE}" >> $GITHUB_OUTPUT
          
          echo "Selected ${AVAILABLE} profiles for CLI mode testing:"
          cat cli-test-results/selected-profiles.txt

      - name: Run all CLI mode tests
        run: |
          cd iccanalyzer-lite
          source ../.github/scripts/sanitize-sed.sh
          
          # ANSI escape code stripper for output files
          strip_ansi() {
            sed -i 's/\x1b\[[0-9;]*[a-zA-Z]//g' "$1"
          }
          
          SUMMARY="../cli-test-results/test-summary.txt"
          echo "==================================================================" > $SUMMARY
          echo "iccAnalyzer-lite CLI Test Suite Report" >> $SUMMARY
          echo "==================================================================" >> $SUMMARY
          echo "" >> $SUMMARY
          echo "Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $SUMMARY
          echo "Binary: $(./iccanalyzer-lite --version 2>&1 | head -1)" >> $SUMMARY
          echo "Build: Debug + ASAN + UBSAN + Coverage" >> $SUMMARY
          echo "Profiles: $(wc -l < ../cli-test-results/selected-profiles.txt)" >> $SUMMARY
          echo "" >> $SUMMARY
          
          # Define CLI modes to test
          MODES="heuristics:h roundtrip:r comprehensive:a ninja:n ninja-full:nf"
          
          GRAND_TOTAL=0
          GRAND_SUCCESS=0
          GRAND_FAILED=0
          
          for MODE_PAIR in $MODES; do
            MODE_NAME="${MODE_PAIR%%:*}"
            MODE_FLAG="-${MODE_PAIR##*:}"
            
            echo "==================================================================" >> $SUMMARY
            echo "Mode: ${MODE_NAME} (${MODE_FLAG})" >> $SUMMARY
            echo "==================================================================" >> $SUMMARY
            echo "" >> $SUMMARY
            
            mkdir -p "../cli-test-results/outputs/${MODE_NAME}"
            
            TOTAL=0
            CLEAN=0
            FINDINGS=0
            
            while IFS= read -r profile; do
              TOTAL=$((TOTAL + 1))
              PROFILE_NAME=$(basename "$profile")
              OUTPUT_FILE="../cli-test-results/outputs/${MODE_NAME}/${PROFILE_NAME}.txt"
              
              echo "[${MODE_NAME}] Testing: ${PROFILE_NAME}"
              echo "Profile: ${PROFILE_NAME}" >> $SUMMARY
              
              if timeout 30s ./iccanalyzer-lite ${MODE_FLAG} "../${profile}" > "$OUTPUT_FILE" 2>&1; then
                strip_ansi "$OUTPUT_FILE"
                # Content-based finding detection (ninja modes exit 0 even for malformed profiles)
                if grep -qai "MISMATCH\|overlap\|extends beyond\|truncat\|\[WARN\].*HEURISTIC\|Suspicious\|UAF RISK\|INVALID\|CORRUPT\|AddressSanitizer\|UndefinedBehaviorSanitizer" "$OUTPUT_FILE" 2>/dev/null; then
                  echo "  Result: FINDING (content)" >> $SUMMARY
                  FINDINGS=$((FINDINGS + 1))
                  echo "  FINDING (content)"
                else
                  echo "  Result: CLEAN" >> $SUMMARY
                  CLEAN=$((CLEAN + 1))
                  echo "  CLEAN"
                fi
              else
                EXIT_CODE=$?
                strip_ansi "$OUTPUT_FILE"
                echo "  Result: FINDING (exit code: $EXIT_CODE)" >> $SUMMARY
                FINDINGS=$((FINDINGS + 1))
                echo "  FINDING (exit $EXIT_CODE)"
                echo "  Detection output:" >> $SUMMARY
                tail -5 "$OUTPUT_FILE" >> $SUMMARY 2>/dev/null || true
              fi
              
              FILE_SIZE=$(stat -c%s "$OUTPUT_FILE" 2>/dev/null || echo 0)
              echo "  Output size: $FILE_SIZE bytes" >> $SUMMARY
              echo "" >> $SUMMARY
              
            done < ../cli-test-results/selected-profiles.txt
            
            echo "---" >> $SUMMARY
            echo "${MODE_NAME} totals: ${CLEAN}/${TOTAL} clean, ${FINDINGS} findings" >> $SUMMARY
            echo "" >> $SUMMARY
            
            GRAND_TOTAL=$((GRAND_TOTAL + TOTAL))
            GRAND_SUCCESS=$((GRAND_SUCCESS + CLEAN))
            GRAND_FAILED=$((GRAND_FAILED + FINDINGS))
            
            # Store per-mode results in env for summary
            echo "${MODE_NAME}_total=$TOTAL" >> $GITHUB_ENV
            echo "${MODE_NAME}_success=$CLEAN" >> $GITHUB_ENV
            echo "${MODE_NAME}_failed=$FINDINGS" >> $GITHUB_ENV
          done
          
          echo "==================================================================" >> $SUMMARY
          echo "FINAL RESULTS" >> $SUMMARY
          echo "==================================================================" >> $SUMMARY
          echo "Grand total: ${GRAND_SUCCESS}/${GRAND_TOTAL} clean, ${GRAND_FAILED} findings" >> $SUMMARY
          RATE=$(awk "BEGIN {printf \"%.1f\", ($GRAND_SUCCESS/$GRAND_TOTAL)*100}")
          echo "Clean rate: ${RATE}%" >> $SUMMARY
          echo "==================================================================" >> $SUMMARY
          
          echo "grand_total=$GRAND_TOTAL" >> $GITHUB_ENV
          echo "grand_success=$GRAND_SUCCESS" >> $GITHUB_ENV
          echo "grand_failed=$GRAND_FAILED" >> $GITHUB_ENV
          
          cat $SUMMARY

      - name: Collect coverage data
        if: always()
        run: |
          set -euo pipefail
          mkdir -p cli-test-results/coverage
          
          if command -v gcov >/dev/null 2>&1; then
            find iccanalyzer-lite -name "*.gcda" -exec gcov {} \; 2>/dev/null | tail -5 || true
            find . -name "*.gcov" -exec cp {} cli-test-results/coverage/ \; 2>/dev/null || true
            COVERAGE_FILES=$(find cli-test-results/coverage -name "*.gcov" 2>/dev/null | wc -l)
            echo "Coverage files collected: ${COVERAGE_FILES}"
          else
            echo "gcov not available"
          fi

      - name: Generate results index
        if: always()
        run: |
          cd cli-test-results
          
          INDEX_FILE="index.html"
          
          cat > $INDEX_FILE << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>iccAnalyzer-lite CLI Test Suite Results</title>
            <style>
              body { font-family: monospace; margin: 20px; background: #f5f5f5; }
              .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; }
              h1 { color: #333; border-bottom: 2px solid #007acc; padding-bottom: 10px; }
              h2 { color: #555; }
              .summary { background: #e8f4f8; padding: 15px; margin: 20px 0; border-left: 4px solid #007acc; }
              .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
              .stat-box { background: #f9f9f9; padding: 15px; border: 1px solid #ddd; text-align: center; }
              .stat-value { font-size: 2em; font-weight: bold; color: #007acc; }
              .stat-label { color: #666; margin-top: 5px; }
              table { width: 100%; border-collapse: collapse; margin: 20px 0; }
              th, td { padding: 10px; text-align: left; border: 1px solid #ddd; }
              th { background: #007acc; color: white; }
              tr:nth-child(even) { background: #f9f9f9; }
              .clean { color: green; font-weight: bold; }
              .finding { color: #cc6600; font-weight: bold; }
              .error { color: red; font-weight: bold; }
              .profile-link { color: #007acc; text-decoration: none; }
              .profile-link:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>iccAnalyzer-lite CLI Test Suite Results</h1>
          EOF
          
          # Add summary stats
          echo "<div class='summary'>" >> $INDEX_FILE
          echo "<strong>Test Date:</strong> $(date -u '+%Y-%m-%d %H:%M:%S UTC')<br>" >> $INDEX_FILE
          echo "<strong>Binary:</strong> iccanalyzer-lite (ASAN + UBSAN + Coverage)<br>" >> $INDEX_FILE
          echo "<strong>Modes:</strong> -h (heuristics), -r (roundtrip), -a (comprehensive), -n (ninja), -nf (ninja-full)" >> $INDEX_FILE
          echo "</div>" >> $INDEX_FILE
          
          echo "<div class='stats'>" >> $INDEX_FILE
          echo "<div class='stat-box'><div class='stat-value'>$grand_total</div><div class='stat-label'>Total Tests</div></div>" >> $INDEX_FILE
          echo "<div class='stat-box'><div class='stat-value' style='color: green;'>$grand_success</div><div class='stat-label'>Clean</div></div>" >> $INDEX_FILE
          echo "<div class='stat-box'><div class='stat-value' style='color: #cc6600;'>$grand_failed</div><div class='stat-label'>Findings</div></div>" >> $INDEX_FILE
          echo "</div>" >> $INDEX_FILE
          
          # Per-mode results tables
          for MODE_NAME in heuristics roundtrip comprehensive ninja ninja-full; do
            if [ -d "outputs/${MODE_NAME}" ]; then
              case "${MODE_NAME}" in
                heuristics)    FLAG="-h" ;;
                roundtrip)     FLAG="-r" ;;
                comprehensive) FLAG="-a" ;;
                ninja)         FLAG="-n" ;;
                ninja-full)    FLAG="-nf" ;;
              esac
              
              echo "<h2>${MODE_NAME} Mode (${FLAG})</h2>" >> $INDEX_FILE
              echo "<table>" >> $INDEX_FILE
              echo "<tr><th>#</th><th>Profile</th><th>Status</th><th>Output</th><th>Size</th></tr>" >> $INDEX_FILE
              
              NUM=1
              while IFS= read -r profile; do
                PROFILE_NAME=$(basename "$profile")
                OUTPUT_FILE="outputs/${MODE_NAME}/${PROFILE_NAME}.txt"
                
                if [ -f "$OUTPUT_FILE" ]; then
                  FILE_SIZE=$(stat -c%s "$OUTPUT_FILE" 2>/dev/null || echo 0)
                  
                  if [ "$FILE_SIZE" -le 1 ]; then
                    STATUS="<span class='error'>ERROR</span>"
                  elif grep -qi "AddressSanitizer\|LeakSanitizer\|UndefinedBehaviorSanitizer\|UBSan\|SUMMARY:.*Sanitizer" "$OUTPUT_FILE" 2>/dev/null; then
                    STATUS="<span class='finding'>FINDING</span>"
                  elif grep -qi "\[ERR\]\|\[WARN\].*HEURISTIC\|Error reading ICC profile\|failed validation\|crash\|SEGV\|ABRT\|stack-smash\|heap-buffer\|memcpy-param-overlap\|double-free\|use-after-free\|MISMATCH\|overlap\|Suspicious\|UAF RISK\|INVALID\|CORRUPT" "$OUTPUT_FILE" 2>/dev/null; then
                    STATUS="<span class='finding'>FINDING</span>"
                  else
                    STATUS="<span class='clean'>CLEAN</span>"
                  fi
                  
                  echo "<tr>" >> $INDEX_FILE
                  echo "<td>$NUM</td>" >> $INDEX_FILE
                  echo "<td><code>$PROFILE_NAME</code></td>" >> $INDEX_FILE
                  echo "<td>$STATUS</td>" >> $INDEX_FILE
                  echo "<td><a class='profile-link' href='$OUTPUT_FILE'>View Output</a></td>" >> $INDEX_FILE
                  echo "<td>$FILE_SIZE bytes</td>" >> $INDEX_FILE
                  echo "</tr>" >> $INDEX_FILE
                  
                  NUM=$((NUM + 1))
                fi
              done < selected-profiles.txt
              
              echo "</table>" >> $INDEX_FILE
            fi
          done
          
          echo "</div></body></html>" >> $INDEX_FILE
          
          echo "Results index created: $INDEX_FILE"

      - name: Upload test results
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        if: always()
        with:
          name: iccanalyzer-cli-test-suite-results
          path: cli-test-results/
          retention-days: 90

      - name: Report to summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## iccAnalyzer-lite CLI Test Suite Results
          
          ### Test Configuration
          - **Binary:** iccanalyzer-lite (ASAN + UBSAN + Coverage)
          - **Modes:** `-h` (heuristics), `-r` (roundtrip), `-a` (comprehensive), `-n` (ninja), `-nf` (ninja-full)
          - **Timeout:** 30 seconds per profile per mode
          
          ### Results Summary
          | Metric | Value |
          |--------|-------|
          | Total Tests | ${{ env.grand_total }} |
          | Clean | ${{ env.grand_success }} |
          | Findings | ${{ env.grand_failed }} |
          
          ### Per-Mode Breakdown
          | Mode | Flag | Clean | Findings | Total |
          |------|------|-------|----------|-------|
          | Heuristics | `-h` | ${{ env.heuristics_success }} | ${{ env.heuristics_failed }} | ${{ env.heuristics_total }} |
          | Round-trip | `-r` | ${{ env.roundtrip_success }} | ${{ env.roundtrip_failed }} | ${{ env.roundtrip_total }} |
          | Comprehensive | `-a` | ${{ env.comprehensive_success }} | ${{ env.comprehensive_failed }} | ${{ env.comprehensive_total }} |
          | Ninja | `-n` | ${{ env.ninja_success }} | ${{ env.ninja_failed }} | ${{ env.ninja_total }} |
          | Ninja-full | `-nf` | ${{ env.ninja-full_success }} | ${{ env.ninja-full_failed }} | ${{ env.ninja-full_total }} |
          
          ### Artifacts
          - Test results uploaded as `iccanalyzer-cli-test-suite-results`
          - Includes individual output files for each profile per mode
          - HTML index with clickable results
          
          ### Status
          EOF
          
          if [ "${{ env.grand_failed }}" -eq 0 ]; then
            echo "**ALL CLEAN** - No sanitizer findings detected across all modes" >> $GITHUB_STEP_SUMMARY
          else
            echo "**${{ env.grand_failed }} FINDING(S)** - Sanitizer detections captured (ASAN/UBSAN/validation errors)" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check test success
        run: |
          if [ "${{ env.grand_failed }}" -eq 0 ]; then
            echo "ALL CLEAN: ${{ env.grand_total }} tests across 5 CLI modes, no findings"
            exit 0
          else
            echo "COMPLETE: ${{ env.grand_success }}/${{ env.grand_total }} clean, ${{ env.grand_failed }} findings"
            echo "Findings are successful sanitizer detections, not infrastructure failures"
            exit 0
          fi