diff --git a/IccProfLib/IccMatrixMath.cpp b/IccProfLib/IccMatrixMath.cpp
index e3a7f16..2aa4075 100644
--- a/IccProfLib/IccMatrixMath.cpp
+++ b/IccProfLib/IccMatrixMath.cpp
@@ -76,6 +76,7 @@
 
 #include "IccMatrixMath.h"
 #include "IccUtil.h"
+#include <cmath>
 #include <cstring>
 #include <cstdio>
 
@@ -382,7 +383,12 @@ bool CIccMatrixMath::SetRange(const icSpectralRange &srcRange, const icSpectralR
       r[srcRange.steps-1] = 1.0;
     }
     else {
-      icUInt16Number p = (icUInt16Number)((w - srcStart) / srcScale);
+      icFloatNumber fIdx = (w - srcStart) / srcScale;
+      if (std::isnan(fIdx) || fIdx < 0.0f)
+        fIdx = 0.0f;
+      else if (fIdx > 65535.0f)
+        fIdx = 65535.0f;
+      icUInt16Number p = (icUInt16Number)fIdx;
       icFloatNumber p2 = (w - (srcStart + p * srcScale)) / srcScale;
       if (p >= srcRange.steps - 1)
         p = srcRange.steps - 2;
